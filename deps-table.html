<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SBOM Play - Table View</title>
    <link href="css/style.css?v=10" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="css/themes.css?v=10" rel="stylesheet">
    <script src="js/theme-manager.js?v=10"></script>
    <style>
        .table-container {
            background: var(--bg-color, #fff);
            border-radius: 8px;
            overflow: hidden;
        }
        
        .sortable {
            cursor: pointer;
            user-select: none;
        }
        
        .sortable:hover {
            background-color: rgba(0,0,0,0.05);
        }
        
        .sort-icon {
            opacity: 0.3;
            font-size: 0.8em;
            margin-left: 5px;
        }
        
        .sort-icon.active {
            opacity: 1;
        }
        
        .badge-direct {
            background: #0d6efd;
        }
        
        .badge-transitive {
            background: #6c757d;
        }
        
        .clickable-cell {
            cursor: pointer;
            color: #0d6efd;
            text-decoration: underline;
        }
        
        .clickable-cell:hover {
            color: #0a58ca;
        }
        
        .stats-row {
            background: var(--bg-secondary, #f8f9fa);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .stat-box {
            text-align: center;
        }
        
        .stat-box h3 {
            margin: 0;
            color: #0d6efd;
        }
        
        .stat-box p {
            margin: 5px 0 0 0;
            color: #6c757d;
            font-size: 0.9em;
        }
        
        [data-theme="dark"] .table {
            color: var(--text-color);
        }
        
        [data-theme="dark"] .table-striped tbody tr:nth-of-type(odd) {
            background-color: rgba(255, 255, 255, 0.05);
        }
        
        [data-theme="dark"] .sortable:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="index.html">
                <i class="fas fa-cubes me-2"></i>SBOM Play
            </a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="index.html">Analysis</a>
                <a class="nav-link" href="stats.html">Stats</a>
                <a class="nav-link" href="license-compliance.html">License</a>
                <a class="nav-link" href="vuln.html">Vulnerabilities</a>
                <a class="nav-link active" href="deps.html">Dependencies</a>
                <a class="nav-link" href="authors.html">Authors</a>
                <a class="nav-link" href="settings.html">
                    <i class="fas fa-cog"></i>
                </a>
                <button class="btn btn-outline-secondary btn-sm ms-2 theme-toggle" onclick="themeManager.toggleTheme()" title="Toggle theme">
                    <i class="fas fa-sun"></i>
                </button>
            </div>
        </div>
    </nav>

    <div class="container-fluid mt-4">
        <div class="row mb-3">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h1><i class="fas fa-table me-2"></i>Table View</h1>
                        <p class="text-muted">Simple searchable and sortable dependency table</p>
                    </div>
                    <div>
                        <a href="deps.html" class="btn btn-outline-secondary">
                            <i class="fas fa-th me-2"></i>All Views
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <!-- Filters -->
        <div class="card mb-3">
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-3">
                        <label class="form-label">Analysis</label>
                        <select class="form-select" id="analysisSelector">
                            <option value="">Select...</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Search</label>
                        <input type="text" class="form-control" id="searchInput" placeholder="Search package name...">
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">Type</label>
                        <select class="form-select" id="typeFilter">
                            <option value="all">All</option>
                            <option value="direct">Direct Only</option>
                            <option value="transitive">Transitive Only</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">Ecosystem</label>
                        <select class="form-select" id="ecosystemFilter">
                            <option value="all">All</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">Repository</label>
                        <select class="form-select" id="repoFilter">
                            <option value="all">All</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>

        <!-- Stats -->
        <div class="stats-row" id="statsRow" style="display: none;">
            <div class="row">
                <div class="col-md-3 stat-box">
                    <h3 id="statTotal">0</h3>
                    <p>Total Dependencies</p>
                </div>
                <div class="col-md-3 stat-box">
                    <h3 id="statDirect">0</h3>
                    <p>Direct</p>
                </div>
                <div class="col-md-3 stat-box">
                    <h3 id="statTransitive">0</h3>
                    <p>Transitive</p>
                </div>
                <div class="col-md-3 stat-box">
                    <h3 id="statShowing">0</h3>
                    <p>Showing (filtered)</p>
                </div>
            </div>
        </div>

        <!-- Table -->
        <div class="card" id="tableCard" style="display: none;">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="fas fa-list me-2"></i>Dependencies</h5>
                <button class="btn btn-sm btn-success" id="exportBtn">
                    <i class="fas fa-download me-2"></i>Export CSV
                </button>
            </div>
            <div class="card-body table-responsive p-0">
                <table class="table table-striped table-hover mb-0">
                    <thead>
                        <tr>
                            <th class="sortable" data-sort="name">
                                Package Name
                                <i class="fas fa-sort sort-icon"></i>
                            </th>
                            <th class="sortable" data-sort="version">
                                Version
                                <i class="fas fa-sort sort-icon"></i>
                            </th>
                            <th class="sortable" data-sort="type">
                                Type
                                <i class="fas fa-sort sort-icon"></i>
                            </th>
                            <th class="sortable" data-sort="ecosystem">
                                Ecosystem
                                <i class="fas fa-sort sort-icon"></i>
                            </th>
                            <th class="sortable" data-sort="repoCount">
                                Used In
                                <i class="fas fa-sort sort-icon"></i>
                            </th>
                            <th>Brought In By</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody">
                    </tbody>
                </table>
            </div>
        </div>

        <div class="alert alert-info" id="noDataMessage">
            <i class="fas fa-info-circle me-2"></i>
            <strong>No Data Available</strong>
            <p class="mb-0 mt-2">Please select an analysis to view dependencies.</p>
        </div>
    </div>

    <!-- Modal for "Brought In By" details -->
    <div class="modal fade" id="parentsModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="parentsModalTitle">Dependency Parents</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="parentsModalBody">
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="js/indexeddb-manager.js?v=10"></script>
    <script src="js/cache-manager.js?v=10"></script>
    <script src="js/storage-manager.js?v=10"></script>
    <script type="module">
        const storageManager = new StorageManager();
        await storageManager.init();
        
        let allDependencies = [];
        let currentData = null;
        let sortColumn = 'name';
        let sortDirection = 'asc';
        
        await loadAnalysesList();
        
        async function loadAnalysesList() {
            const storageInfo = await storageManager.getStorageInfo();
            const selector = document.getElementById('analysisSelector');
            const allEntries = [...storageInfo.organizations, ...storageInfo.repositories];
            
            if (allEntries.length === 0) {
                document.getElementById('noDataMessage').style.display = 'block';
                return;
            }
            
            allEntries.forEach(entry => {
                const option = document.createElement('option');
                option.value = entry.name;
                option.textContent = `${entry.name} (${entry.dependencies} deps)`;
                selector.appendChild(option);
            });
            
            if (allEntries.length > 0) {
                selector.value = allEntries[0].name;
                await loadAnalysis();
            }
        }
        
        document.getElementById('analysisSelector').addEventListener('change', loadAnalysis);
        document.getElementById('searchInput').addEventListener('input', filterTable);
        document.getElementById('typeFilter').addEventListener('change', filterTable);
        document.getElementById('ecosystemFilter').addEventListener('change', filterTable);
        document.getElementById('repoFilter').addEventListener('change', filterTable);
        document.getElementById('exportBtn').addEventListener('click', exportCSV);
        
        // Sort handlers
        document.querySelectorAll('.sortable').forEach(header => {
            header.addEventListener('click', () => {
                const column = header.getAttribute('data-sort');
                if (sortColumn === column) {
                    sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
                } else {
                    sortColumn = column;
                    sortDirection = 'asc';
                }
                updateSortIcons();
                filterTable();
            });
        });
        
        function updateSortIcons() {
            document.querySelectorAll('.sort-icon').forEach(icon => {
                icon.className = 'fas fa-sort sort-icon';
            });
            const activeHeader = document.querySelector(`[data-sort="${sortColumn}"]`);
            if (activeHeader) {
                const icon = activeHeader.querySelector('.sort-icon');
                icon.className = `fas fa-sort-${sortDirection === 'asc' ? 'up' : 'down'} sort-icon active`;
            }
        }
        
        async function loadAnalysis() {
            const analysisName = document.getElementById('analysisSelector').value;
            if (!analysisName) return;
            
            const data = await storageManager.loadAnalysisDataForOrganization(analysisName);
            if (!data || !data.data) {
                alert('No data found');
                return;
            }
            
            currentData = data.data;
            allDependencies = processData(currentData);
            
            // Populate ecosystem filter
            const ecosystems = [...new Set(allDependencies.map(d => d.ecosystem))].sort();
            const ecosystemFilter = document.getElementById('ecosystemFilter');
            ecosystemFilter.innerHTML = '<option value="all">All</option>';
            ecosystems.forEach(eco => {
                const option = document.createElement('option');
                option.value = eco;
                option.textContent = eco.charAt(0).toUpperCase() + eco.slice(1);
                ecosystemFilter.appendChild(option);
            });
            
            // Populate repo filter
            const repos = [...new Set(allDependencies.flatMap(d => d.repositories))].sort();
            const repoFilter = document.getElementById('repoFilter');
            repoFilter.innerHTML = '<option value="all">All</option>';
            repos.forEach(repo => {
                const option = document.createElement('option');
                option.value = repo;
                option.textContent = repo;
                repoFilter.appendChild(option);
            });
            
            document.getElementById('tableCard').style.display = 'block';
            document.getElementById('statsRow').style.display = 'block';
            document.getElementById('noDataMessage').style.display = 'none';
            
            filterTable();
        }
        
        function processData(data) {
            const deps = [];
            const repos = data.allRepositories || [];
            const allDeps = data.allDependencies || [];
            
            allDeps.forEach(dep => {
                const isDirect = dep.directIn && dep.directIn.length > 0;
                const isTransitive = dep.transitiveIn && dep.transitiveIn.length > 0;
                
                // Get parent dependencies
                const parents = new Set();
                repos.forEach(repo => {
                    if (repo.relationships) {
                        const spdxToPackage = new Map();
                        if (repo.spdxPackages) {
                            repo.spdxPackages.forEach(pkg => {
                                if (pkg.SPDXID && pkg.name) {
                                    spdxToPackage.set(pkg.SPDXID, `${pkg.name}@${normalizeVersion(pkg.version || '')}`);
                                }
                            });
                        }
                        
                        const targetKey = `${dep.name}@${dep.version}`;
                        repo.relationships.forEach(rel => {
                            const targetPkg = spdxToPackage.get(rel.to);
                            if (targetPkg === targetKey && !rel.isDirectFromMain) {
                                const sourcePkg = spdxToPackage.get(rel.from);
                                if (sourcePkg) parents.add(sourcePkg);
                            }
                        });
                    }
                });
                
                deps.push({
                    name: dep.name,
                    version: dep.version,
                    type: isDirect ? 'direct' : 'transitive',
                    ecosystem: dep.category?.ecosystem || 'unknown',
                    language: dep.category?.language || '',
                    repositories: dep.repositories || [],
                    repoCount: (dep.repositories || []).length,
                    parents: Array.from(parents),
                    raw: dep
                });
            });
            
            return deps;
        }
        
        function normalizeVersion(version) {
            if (!version) return '';
            return version.trim().replace(/^[><=^~]+\s*/, '').replace(/\s*-\s*[\d.]+.*$/, '').replace(/\s*\|\|.*$/, '').replace(/\s+/g, '');
        }
        
        function filterTable() {
            const search = document.getElementById('searchInput').value.toLowerCase();
            const typeFilter = document.getElementById('typeFilter').value;
            const ecosystemFilter = document.getElementById('ecosystemFilter').value;
            const repoFilter = document.getElementById('repoFilter').value;
            
            let filtered = allDependencies.filter(dep => {
                if (search && !dep.name.toLowerCase().includes(search)) return false;
                if (typeFilter !== 'all' && dep.type !== typeFilter) return false;
                if (ecosystemFilter !== 'all' && dep.ecosystem !== ecosystemFilter) return false;
                if (repoFilter !== 'all' && !dep.repositories.includes(repoFilter)) return false;
                return true;
            });
            
            // Sort
            filtered.sort((a, b) => {
                let aVal = a[sortColumn];
                let bVal = b[sortColumn];
                
                if (typeof aVal === 'string') {
                    aVal = aVal.toLowerCase();
                    bVal = bVal.toLowerCase();
                }
                
                if (sortDirection === 'asc') {
                    return aVal < bVal ? -1 : aVal > bVal ? 1 : 0;
                } else {
                    return aVal > bVal ? -1 : aVal < bVal ? 1 : 0;
                }
            });
            
            updateStats(filtered);
            renderTable(filtered);
        }
        
        function updateStats(filtered) {
            const directCount = allDependencies.filter(d => d.type === 'direct').length;
            const transitiveCount = allDependencies.filter(d => d.type === 'transitive').length;
            
            document.getElementById('statTotal').textContent = allDependencies.length;
            document.getElementById('statDirect').textContent = directCount;
            document.getElementById('statTransitive').textContent = transitiveCount;
            document.getElementById('statShowing').textContent = filtered.length;
        }
        
        function renderTable(deps) {
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = '';
            
            deps.forEach(dep => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td><strong>${escapeHtml(dep.name)}</strong></td>
                    <td>${escapeHtml(dep.version)}</td>
                    <td><span class="badge badge-${dep.type}">${dep.type}</span></td>
                    <td>${escapeHtml(dep.ecosystem)}</td>
                    <td>${dep.repoCount} ${dep.repoCount === 1 ? 'repo' : 'repos'}</td>
                    <td>
                        ${dep.type === 'direct' 
                            ? '<span class="text-muted">Direct dependency</span>' 
                            : dep.parents.length > 0 
                                ? `<span class="clickable-cell" data-parents='${JSON.stringify(dep.parents)}'>${dep.parents.length} ${dep.parents.length === 1 ? 'parent' : 'parents'}</span>`
                                : '<span class="text-muted">Unknown</span>'
                        }
                    </td>
                `;
                tbody.appendChild(tr);
            });
            
            // Add click handlers for parents
            document.querySelectorAll('.clickable-cell').forEach(cell => {
                cell.addEventListener('click', () => {
                    const parents = JSON.parse(cell.getAttribute('data-parents'));
                    showParentsModal(parents);
                });
            });
        }
        
        function showParentsModal(parents) {
            const modalBody = document.getElementById('parentsModalBody');
            modalBody.innerHTML = `
                <p>This transitive dependency is brought in by the following direct dependencies:</p>
                <ul class="list-group">
                    ${parents.map(p => `<li class="list-group-item">${escapeHtml(p)}</li>`).join('')}
                </ul>
            `;
            new bootstrap.Modal(document.getElementById('parentsModal')).show();
        }
        
        function exportCSV() {
            const search = document.getElementById('searchInput').value.toLowerCase();
            const typeFilter = document.getElementById('typeFilter').value;
            const ecosystemFilter = document.getElementById('ecosystemFilter').value;
            const repoFilter = document.getElementById('repoFilter').value;
            
            let filtered = allDependencies.filter(dep => {
                if (search && !dep.name.toLowerCase().includes(search)) return false;
                if (typeFilter !== 'all' && dep.type !== typeFilter) return false;
                if (ecosystemFilter !== 'all' && dep.ecosystem !== ecosystemFilter) return false;
                if (repoFilter !== 'all' && !dep.repositories.includes(repoFilter)) return false;
                return true;
            });
            
            const csv = [
                ['Package Name', 'Version', 'Type', 'Ecosystem', 'Repositories', 'Brought In By'].join(','),
                ...filtered.map(dep => [
                    `"${dep.name}"`,
                    `"${dep.version}"`,
                    dep.type,
                    dep.ecosystem,
                    `"${dep.repositories.join(', ')}"`,
                    dep.type === 'direct' ? 'N/A' : `"${dep.parents.join(', ')}"`
                ].join(','))
            ].join('\n');
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `dependencies-${Date.now()}.csv`;
            a.click();
            URL.revokeObjectURL(url);
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    </script>
</body>
</html>

