<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Author Analysis (Experimental) - SBOM Play</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="css/style.css?v=0.0.2">
    <link rel="stylesheet" href="css/themes.css?v=0.0.2">
    <script src="js/theme-manager.js?v=0.0.2"></script>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="index.html">
                <i class="fas fa-cube me-2"></i>SBOM Play
            </a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="index.html">Home</a>
                <a class="nav-link" href="licenses.html">License</a>
                <a class="nav-link" href="vuln.html">Vulns</a>
                <a class="nav-link" href="quality.html">Quality</a>
                <a class="nav-link" href="deps.html">Deps</a>
                <a class="nav-link" href="repos.html">Repos</a>
                <a class="nav-link active" href="authors.html">Authors</a>
                <a class="nav-link" href="about.html">About</a>
                <a class="nav-link" href="settings.html">
                    <i class="fas fa-cog"></i>
                </a>
                <button class="btn btn-outline-secondary btn-sm ms-2 theme-toggle" onclick="themeManager.toggleTheme()" title="Toggle theme">
                    <i class="fas fa-sun"></i>
                </button>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <div class="alert alert-warning alert-dismissible fade show" role="alert">
            <i class="fas fa-flask me-2"></i>
            <strong>Experimental Feature:</strong> This page is currently experimental and may have limitations or incomplete data.
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
        
        <!-- Header -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h1><i class="fas fa-users me-2"></i>Author Analysis <span class="badge bg-warning text-dark">Experimental</span></h1>
                        <p class="text-muted">View package authors and maintainers from third-party dependencies ranked by contribution across your supply chain</p>
                    </div>
                    <div>
                        <a href="index.html" class="btn btn-outline-primary">
                            <i class="fas fa-arrow-left me-2"></i>Back to Analysis
                        </a>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="alert alert-info alert-dismissible fade show mb-4" role="alert">
            <i class="fas fa-info-circle me-2"></i>
            <strong>Important:</strong> The authors, contributors, and maintainers listed here are from 
            <strong>third-party packages and dependencies</strong> used by your repositories, not the 
            repository authors themselves. This shows who maintains the external libraries your project depends on.
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
        
        <!-- View Selector -->
        <div class="card mb-4">
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <label class="form-label">Select Analysis</label>
                        <select class="form-select" id="analysisSelector">
                            <option value="combined">Combined (All Scans)</option>
                        </select>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Filter by Ecosystem</label>
                        <select class="form-select" id="ecosystemFilter">
                            <option value="all">All Ecosystems</option>
                            <option value="npm">NPM</option>
                            <option value="pypi">PyPI</option>
                            <option value="maven">Maven</option>
                            <option value="cargo">Cargo</option>
                            <option value="go">Go</option>
                            <option value="nuget">NuGet</option>
                            <option value="composer">Composer</option>
                            <option value="rubygems">RubyGems</option>
                        </select>
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-12">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="fundingFilter" value="funding">
                            <label class="form-check-label" for="fundingFilter">
                                <i class="fas fa-heart me-1 text-danger"></i>Show only authors looking for sponsorship
                            </label>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Author List -->
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-list me-2"></i>Authors by Contribution</h5>
            </div>
            <div class="card-body">
                <div id="authorContent">
                    <p class="text-muted text-center">Loading author data...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Package List Modal -->
    <div class="modal fade" id="packageModal" tabindex="-1" aria-labelledby="packageModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="packageModalLabel">Packages</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="packageModalContent"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Author Details Modal -->
    <div class="modal fade" id="authorDetailsModal" tabindex="-1" aria-labelledby="authorDetailsModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="authorDetailsModalLabel">Author Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="authorDetailsContent"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="js/indexeddb-manager.js?v=0.0.2"></script>
    <script src="js/utils.js?v=0.0.2"></script>
    <script src="js/registry-utils.js?v=0.0.2"></script>
    <script src="js/version-utils.js?v=0.0.2"></script>
    <script src="js/ecosystem-utils.js?v=0.0.2"></script>
    <script src="js/cache-manager.js?v=0.0.2"></script>
    <script src="js/storage-manager.js?v=0.0.2"></script>
    <script src="js/author-service.js?v=0.0.2"></script>
    <script type="module">
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('ðŸ‘¥ Authors Page - Initializing...');
            
            // Store authors globally for event handlers (must be at top of scope)
            let currentAuthors = [];
            
            // Create AuthorService instance for secure URL validation
            const authorService = new AuthorService();
            
            // escapeHtml is now provided by utils.js
            
            const storageManager = new StorageManager();
            await storageManager.init();
            console.log('âœ… Authors Page - Storage initialized');
            
            // Load available analyses
            await loadAnalysisList();
            console.log('âœ… Authors Page - Analysis list loaded');
            
            // Check for funding and repo filters in URL and pre-check checkbox
            const urlParams = new URLSearchParams(window.location.search);
            const repoParam = urlParams.get('repo');
            if (urlParams.get('funding') === 'true') {
                const fundingFilterCheckbox = document.getElementById('fundingFilter');
                if (fundingFilterCheckbox) {
                    fundingFilterCheckbox.checked = true;
                }
                // Show notice about funding filter
                const notice = document.createElement('div');
                notice.className = 'alert alert-info alert-dismissible fade show mt-3';
                notice.innerHTML = `
                    <i class="fas fa-heart me-2"></i>
                    <strong>Funding Filter Active:</strong> Showing only authors that accept personal sponsorships.
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                `;
                document.querySelector('.container').insertBefore(notice, document.querySelector('.container').firstChild);
            }
            
            // Store repoParam globally for use in loadAuthorData
            window.repoParam = repoParam;
            
            // Setup event listeners
            document.getElementById('analysisSelector').addEventListener('change', loadAuthorData);
            document.getElementById('ecosystemFilter').addEventListener('change', loadAuthorData);
            document.getElementById('fundingFilter').addEventListener('change', loadAuthorData);
            
            // Load initial data
            console.log('ðŸ“Š Authors Page - Loading initial author data...');
            await loadAuthorData();
            
            async function loadAnalysisList() {
                const storageInfo = await storageManager.getStorageInfo();
                const selector = document.getElementById('analysisSelector');
                
                console.log('ðŸ“‹ Authors Page - Storage info:', storageInfo);
                console.log('ðŸ“‹ Authors Page - Organizations:', storageInfo.organizations);
                console.log('ðŸ“‹ Authors Page - Repositories:', storageInfo.repositories);
                
                // Add combined option (already there)
                
                // Add individual analyses
                const allEntries = [...storageInfo.organizations, ...storageInfo.repositories];
                console.log(`ðŸ“‹ Authors Page - Adding ${allEntries.length} entries to selector`);
                
                allEntries.forEach(entry => {
                    const option = document.createElement('option');
                    option.value = entry.name;
                    option.textContent = entry.name;
                    selector.appendChild(option);
                });
            }
            
            async function loadAuthorData() {
                const analysisId = document.getElementById('analysisSelector').value;
                const ecosystem = document.getElementById('ecosystemFilter').value;
                
                console.log(`ðŸ“Š Authors Page - Loading data for: ${analysisId}, ecosystem: ${ecosystem}`);
                
                let authorData;
                
                if (analysisId === 'combined') {
                    console.log('ðŸ“Š Authors Page - Loading combined authors...');
                    authorData = await loadCombinedAuthors();
                } else {
                    console.log(`ðŸ“Š Authors Page - Loading single analysis: ${analysisId}`);
                    authorData = await loadSingleAnalysisAuthors(analysisId);
                }
                
                console.log(`ðŸ“Š Authors Page - Loaded ${authorData ? authorData.length : 0} authors`);
                
                // Filter by repository if repo parameter is present
                if (window.repoParam && authorData) {
                    authorData = authorData.filter(author => {
                        // Check if any of the author's packages are used in the specified repository
                        if (author.packageRepositories) {
                            return Object.values(author.packageRepositories).some(repos => 
                                repos && repos.includes(window.repoParam)
                            );
                        }
                        // Fallback: check repositories array
                        if (author.repositories && Array.isArray(author.repositories)) {
                            return author.repositories.includes(window.repoParam);
                        }
                        return false;
                    });
                    console.log(`ðŸ“Š Authors Page - Filtered to ${authorData.length} authors for repo ${window.repoParam}`);
                }
                
                displayAuthors(authorData, ecosystem);
            }
            
            // Normalize author name for deduplication (remove case, spaces, special chars)
            function normalizeAuthorName(name) {
                return name.toLowerCase()
                    .replace(/\s+/g, '')
                    .replace(/[^a-z0-9]/g, '');
            }
            
            // Check if two author names likely refer to the same person
            function areSimilarAuthors(name1, name2) {
                const norm1 = normalizeAuthorName(name1);
                const norm2 = normalizeAuthorName(name2);
                
                // Exact match after normalization
                if (norm1 === norm2) return true;
                
                // Check if one is contained in the other (e.g., "sindresorhus" in "Sindre Sorhus")
                if (norm1.includes(norm2) || norm2.includes(norm1)) {
                    // Only if they're reasonably close in length
                    const lenRatio = Math.min(norm1.length, norm2.length) / Math.max(norm1.length, norm2.length);
                    if (lenRatio > 0.5) return true;
                }
                
                return false;
            }

            async function loadCombinedAuthors() {
                const storageInfo = await storageManager.getStorageInfo();
                const allAuthors = new Map();
                
                const allEntries = [...storageInfo.organizations, ...storageInfo.repositories];
                console.log(`ðŸ“Š Authors Page - Combining authors from ${allEntries.length} entries`);
                
                for (const entry of allEntries) {
                    console.log(`ðŸ“Š Authors Page - Loading data for: ${entry.name}`);
                    const data = await storageManager.loadAnalysisDataForOrganization(entry.name);
                    
                    if (data) {
                        console.log(`ðŸ“Š Authors Page - Data structure for ${entry.name}:`, {
                            hasData: !!data.data,
                            hasAuthorAnalysis: !!data.data?.authorAnalysis,
                            hasAuthors: !!data.data?.authorAnalysis?.authors,
                            authorCount: data.data?.authorAnalysis?.authors?.length || 0
                        });
                    } else {
                        console.log(`âš ï¸ Authors Page - No data found for ${entry.name}`);
                    }
                    
                    if (data?.data?.authorAnalysis?.authors) {
                        console.log(`âœ… Authors Page - Found ${data.data.authorAnalysis.authors.length} authors in ${entry.name}`);
                        
                        const authorRefs = data.data.authorAnalysis.authors;
                        const isNewFormat = data.data.authorAnalysis._cacheVersion === 3 || 
                                           (authorRefs.length > 0 && authorRefs[0].authorKey);
                        
                        if (isNewFormat && window.cacheManager) {
                            // NEW FORMAT: Resolve references from cache
                            for (const ref of authorRefs) {
                                const authorEntity = await window.cacheManager.getAuthorEntity(ref.authorKey);
                                const author = {
                                    author: authorEntity?.author || ref.authorKey.split(':')[1] || ref.authorKey,
                                    ecosystem: authorEntity?.ecosystem || ref.ecosystem,
                                    packages: ref.packages || [],
                                    packageRepositories: ref.packageRepositories || {},
                                    repositories: ref.repositories || [],
                                    repositoryCount: ref.repositoryCount || 0,
                                    count: ref.count || 0,
                                    funding: authorEntity?.funding || null,
                                    metadata: authorEntity?.metadata || null
                                };
                                
                                // Try to find similar existing author
                                let foundKey = null;
                                for (const [existingKey, existingAuthor] of allAuthors.entries()) {
                                    const [existingEcosystem, existingName] = existingKey.split(':', 2);
                                    if (existingEcosystem === author.ecosystem && areSimilarAuthors(existingName, author.author)) {
                                        foundKey = existingKey;
                                        break;
                                    }
                                }
                                
                                if (foundKey) {
                                    // Merge with existing author
                                    const existing = allAuthors.get(foundKey);
                                    existing.count += author.count;
                                    existing.packages.push(...author.packages);
                                    existing.packages = [...new Set(existing.packages)];
                                    // Merge repository data
                                    if (author.packageRepositories) {
                                        Object.keys(author.packageRepositories).forEach(pkg => {
                                            if (!existing.packageRepositories[pkg]) {
                                                existing.packageRepositories[pkg] = [];
                                            }
                                            existing.packageRepositories[pkg].push(...author.packageRepositories[pkg]);
                                            existing.packageRepositories[pkg] = [...new Set(existing.packageRepositories[pkg])];
                                        });
                                    }
                                    // Keep the longer name
                                    if (author.author.length > existing.author.length) {
                                        existing.author = author.author;
                                    }
                                    // Merge metadata if available
                                    if (author.metadata && !existing.metadata) {
                                        existing.metadata = author.metadata;
                                    }
                                    if (author.funding && !existing.funding) {
                                        existing.funding = author.funding;
                                    }
                                } else {
                                    // Add new author
                                    const key = ref.authorKey || `${author.ecosystem}:${author.author}`;
                                    allAuthors.set(key, { 
                                        ...author, 
                                        packages: [...author.packages],
                                        metadata: author.metadata || null
                                    });
                                }
                            }
                        } else {
                            // OLD FORMAT: Handle as before (backward compatibility)
                            data.data.authorAnalysis.authors.forEach(author => {
                                // Try to find similar existing author
                                let foundKey = null;
                                for (const [existingKey, existingAuthor] of allAuthors.entries()) {
                                    const [existingEcosystem, existingName] = existingKey.split(':', 2);
                                    if (existingEcosystem === author.ecosystem && areSimilarAuthors(existingName, author.author)) {
                                        foundKey = existingKey;
                                        break;
                                    }
                                }
                                
                                if (foundKey) {
                                    // Merge with existing author
                                    const existing = allAuthors.get(foundKey);
                                    existing.count += author.count;
                                    existing.packages.push(...author.packages);
                                    existing.packages = [...new Set(existing.packages)];
                                    // Keep the longer name (usually the full name)
                                    if (author.author.length > existing.author.length) {
                                        existing.author = author.author;
                                    }
                                    // Merge metadata if available
                                    if (author.metadata && !existing.metadata) {
                                        existing.metadata = author.metadata;
                                    }
                                } else {
                                    // Add new author
                                    const key = `${author.ecosystem}:${author.author}`;
                                    allAuthors.set(key, { 
                                        ...author, 
                                        packages: [...author.packages],
                                        metadata: author.metadata || null
                                    });
                                }
                            });
                        }
                    }
                }
                
                const result = Array.from(allAuthors.values())
                    .sort((a, b) => b.count - a.count);
                
                console.log(`ðŸ“Š Authors Page - Combined total: ${result.length} unique authors`);
                return result;
            }
            
            async function loadSingleAnalysisAuthors(analysisId) {
                console.log(`ðŸ“Š Authors Page - Loading single analysis: ${analysisId}`);
                const data = await storageManager.loadAnalysisDataForOrganization(analysisId);
                
                if (data) {
                    console.log(`ðŸ“Š Authors Page - Data for ${analysisId}:`, {
                        hasData: !!data.data,
                        hasAuthorAnalysis: !!data.data?.authorAnalysis,
                        hasAuthors: !!data.data?.authorAnalysis?.authors,
                        authorCount: data.data?.authorAnalysis?.authors?.length || 0,
                        cacheVersion: data.data?.authorAnalysis?._cacheVersion
                    });
                } else {
                    console.log(`âš ï¸ Authors Page - No data found for ${analysisId}`);
                }
                
                const authorRefs = data?.data?.authorAnalysis?.authors || [];
                
                // Check if this is new format (references) or old format (full data)
                const isNewFormat = data?.data?.authorAnalysis?._cacheVersion === 3 || 
                                   (authorRefs.length > 0 && authorRefs[0].authorKey);
                
                if (isNewFormat && window.cacheManager) {
                    // NEW FORMAT: Resolve author references from cache
                    console.log(`ðŸ“¦ Authors Page - Resolving ${authorRefs.length} author references from cache...`);
                    const authors = await Promise.all(
                        authorRefs.map(async (ref) => {
                            const authorEntity = await window.cacheManager.getAuthorEntity(ref.authorKey);
                            if (authorEntity) {
                                return {
                                    author: authorEntity.author || ref.authorKey.split(':')[1],
                                    ecosystem: authorEntity.ecosystem || ref.ecosystem,
                                    packages: ref.packages || [],
                                    packageRepositories: ref.packageRepositories || {},
                                    repositories: ref.repositories || [],
                                    repositoryCount: ref.repositoryCount || 0,
                                    count: ref.count || 0,
                                    funding: authorEntity.funding || null,
                                    metadata: authorEntity.metadata || null
                                };
                            } else {
                                // Fallback if cache miss
                                const [, authorName] = ref.authorKey.split(':');
                                return {
                                    author: authorName || ref.authorKey,
                                    ecosystem: ref.ecosystem,
                                    packages: ref.packages || [],
                                    packageRepositories: ref.packageRepositories || {},
                                    repositories: ref.repositories || [],
                                    repositoryCount: ref.repositoryCount || 0,
                                    count: ref.count || 0,
                                    funding: null,
                                    metadata: null
                                };
                            }
                        })
                    );
                    console.log(`âœ… Authors Page - Resolved ${authors.length} authors from cache`);
                    return authors;
                } else {
                    // OLD FORMAT: Return as-is (backward compatibility)
                    console.log(`ðŸ“Š Authors Page - Using legacy format (${authorRefs.length} authors)`);
                    return authorRefs;
                }
            }
            
            function showPackageModal(author) {
                const modal = new bootstrap.Modal(document.getElementById('packageModal'));
                const uniquePackages = [...new Set(author.packages)].sort();
                const packageRepositories = author.packageRepositories || {};
                const repositoryCount = author.repositoryCount || 0;
                
                document.getElementById('packageModalLabel').textContent = 
                    `${uniquePackages.length} Package${uniquePackages.length !== 1 ? 's' : ''} by ${author.author}`;
                
                // Get current organization context for links
                const currentOrg = document.getElementById('analysisSelector')?.value || 'combined';
                const orgParamForLink = (currentOrg === 'combined' || currentOrg === 'Combined (All Scans)') ? null : currentOrg;
                
                // Helper function to create deps.html URL with package search filter
                const createPackageLink = (packageName) => {
                    const params = new URLSearchParams();
                    if (orgParamForLink) {
                        params.set('org', orgParamForLink);
                    }
                    params.set('search', packageName);
                    return `deps.html?${params.toString()}`;
                };
                
                // Helper function to create deps.html URL with repo filter
                const createRepoLink = (repo) => {
                    const params = new URLSearchParams();
                    if (orgParamForLink) {
                        params.set('org', orgParamForLink);
                    }
                    params.set('repo', repo);
                    return `deps.html?${params.toString()}`;
                };
                
                let html = `
                    <div class="mb-3">
                        <strong>Ecosystem:</strong> <span class="badge bg-info">${author.ecosystem}</span><br>
                        <strong>Total Packages:</strong> <span class="badge bg-primary">${uniquePackages.length}</span><br>
                        <strong>Repository Usage:</strong> <span class="badge bg-secondary">${repositoryCount} repo${repositoryCount !== 1 ? 's' : ''}</span>
                    </div>
                    <div class="list-group max-h-400 overflow-y-auto">
                `;
                
                uniquePackages.forEach(pkg => {
                    const repos = packageRepositories[pkg] || [];
                    const repoCount = repos.length;
                    
                    html += `
                        <div class="list-group-item">
                            <div class="d-flex justify-content-between align-items-start">
                                <div class="flex-grow-1">
                                    <strong><a href="${createPackageLink(pkg)}" class="text-decoration-none" target="_blank">${escapeHtml(pkg)}</a></strong>
                                    ${repoCount > 0 ? `
                                        <br><small class="text-muted">
                                            <i class="fas fa-folder me-1"></i>
                                            Used in <strong>${repoCount}</strong> repositor${repoCount !== 1 ? 'ies' : 'y'}
                                        </small>
                                    ` : ''}
                                </div>
                                ${repoCount > 0 ? `<span class="badge bg-secondary ms-2">${repoCount}</span>` : ''}
                            </div>
                            ${repoCount > 0 && repoCount <= 10 ? `
                                <div class="mt-2">
                                    <small class="text-muted">
                                        <i class="fas fa-code-branch me-1"></i>
                                        ${repos.map(r => `<a href="${createRepoLink(r)}" class="text-decoration-none" target="_blank"><code>${escapeHtml(r)}</code></a>`).join(', ')}
                                    </small>
                                </div>
                            ` : repoCount > 10 ? `
                                <div class="mt-2">
                                    <small class="text-muted">
                                        <i class="fas fa-code-branch me-1"></i>
                                        ${repos.slice(0, 5).map(r => `<a href="${createRepoLink(r)}" class="text-decoration-none" target="_blank"><code>${escapeHtml(r)}</code></a>`).join(', ')}
                                        <strong>+ ${repoCount - 5} more</strong>
                                    </small>
                                </div>
                            ` : ''}
                        </div>
                    `;
                });
                
                html += '</div>';
                
                document.getElementById('packageModalContent').innerHTML = html;
                modal.show();
            }
            
        // Generate registry profile URLs only if we have verified data
        function getVerifiedProfileLinks(author) {
            const links = [];
            
            // Only show npm profile if we know they're a maintainer (from our author extraction)
            // npm profiles use the username (from maintainers[].name), not the display name (from author.name)
            // e.g., username "tmpvar" not display name "Elijah Insua", or "shama" not "Kyle Robinson Young"
            if (author.ecosystem === 'npm' && author.author) {
                // Use npm_username from metadata if available (from maintainers[].name or ecosyste.ms login)
                // This is critical: author.author might be display name (e.g., "Kyle Robinson Young")
                // but npm_username is the actual username (e.g., "shama")
                const npmUsername = author.metadata?.npm_username || author.author;
                // Only show if we have a valid username (not empty and doesn't look like a display name with spaces)
                if (npmUsername && !npmUsername.includes(' ')) {
                    links.push({
                        url: `https://www.npmjs.com/~${encodeURIComponent(npmUsername)}`,
                        icon: 'fab fa-npm',
                        label: 'npm Profile',
                        class: 'btn-outline-danger'
                    });
                }
            }
            
            // PyPI profile - handle both organizations and users
            // NOTE: PyPI JSON API doesn't provide explicit organization field
            // We detect organizations from patterns in the JSON response (name + email domain analysis)
            if (author.ecosystem === 'pypi' && author.author) {
                // Check metadata first (organization detection done during extraction)
                if (author.metadata?.pypi_organization) {
                    // This is an organization (detected from PyPI JSON patterns)
                    links.push({
                        url: `https://pypi.org/org/${encodeURIComponent(author.metadata.pypi_organization)}/`,
                        icon: 'fas fa-cube',
                        label: 'PyPI Organization',
                        class: 'btn-outline-primary'
                    });
                } else if (author.metadata?.pypi_username) {
                    // This is a user with known username
                    links.push({
                        url: `https://pypi.org/user/${encodeURIComponent(author.metadata.pypi_username)}/`,
                        icon: 'fas fa-cube',
                        label: 'PyPI Profile',
                        class: 'btn-outline-primary'
                    });
                } else {
                    // Fallback: try to infer from author name/email patterns
                    const authorName = author.author.trim();
                    const isLikelyOrg = !authorName.includes(' ') && !authorName.includes(',') && 
                                       authorName.length > 0;
                    
                    if (isLikelyOrg) {
                        // Try organization URL format as fallback
                        links.push({
                            url: `https://pypi.org/org/${encodeURIComponent(authorName.toLowerCase())}/`,
                            icon: 'fas fa-cube',
                            label: 'PyPI Organization',
                            class: 'btn-outline-primary'
                        });
                    } else {
                        // Try to extract username from author string if it contains email format
                        const emailMatch = author.author.match(/<([^>]+)>/);
                        if (emailMatch) {
                            const username = emailMatch[1].split('@')[0];
                            links.push({
                                url: `https://pypi.org/user/${encodeURIComponent(username)}/`,
                                icon: 'fas fa-cube',
                                label: 'PyPI Profile',
                                class: 'btn-outline-primary'
                            });
                        } else if (author.author.includes('@')) {
                            const username = author.author.split('@')[0];
                            links.push({
                                url: `https://pypi.org/user/${encodeURIComponent(username)}/`,
                                icon: 'fas fa-cube',
                                label: 'PyPI Profile',
                                class: 'btn-outline-primary'
                            });
                        }
                    }
                }
            }
            
            // Crates.io profile (from login)
            if (author.ecosystem === 'cargo' && author.author) {
                links.push({
                    url: `https://crates.io/users/${encodeURIComponent(author.author)}`,
                    icon: 'fas fa-box',
                    label: 'Crates.io Profile',
                    class: 'btn-outline-warning'
                });
            }
            
            // RubyGems profile
            // RubyGems uses lowercase usernames (e.g., "parker" not "Parker Moore")
            // Use rubygems_username from metadata if available, otherwise normalize author name
            if (author.ecosystem === 'gem' && author.author) {
                let rubygemsUsername = author.metadata?.rubygems_username;
                if (!rubygemsUsername) {
                    // Normalize author name: lowercase, remove spaces and special characters
                    // RubyGems usernames are typically lowercase with no spaces
                    rubygemsUsername = author.author.toLowerCase().trim().replace(/\s+/g, '');
                }
                links.push({
                    url: `https://rubygems.org/profiles/${encodeURIComponent(rubygemsUsername)}`,
                    icon: 'fas fa-gem',
                    label: 'RubyGems Profile',
                    class: 'btn-outline-danger'
                });
            }
            
            // GitHub profile (only if we extracted from repo or it's a github: prefixed author)
            if (author.ecosystem === 'github' || author.metadata?.github) {
                const githubUsername = author.metadata?.github || author.author;
                links.push({
                    url: `https://github.com/${encodeURIComponent(githubUsername)}`,
                    icon: 'fab fa-github',
                    label: 'GitHub Profile',
                    class: 'btn-outline-secondary'
                });
            }
            
            return links;
        }

            async function showAuthorDetailsModal(author) {
                const modal = new bootstrap.Modal(document.getElementById('authorDetailsModal'));
                document.getElementById('authorDetailsModalLabel').textContent = author.author;
                
                const allPackages = [...new Set(author.packages)].sort();
                const uniquePackageCount = allPackages.length;
                const occurrenceCount = author.count; // How many times author was found across dependencies
                const repositoryCount = author.repositoryCount || 0;
                const packageRepositories = author.packageRepositories || {};
                
                let html = `
                    <div class="mb-3">
                        <h6><i class="fas fa-user me-2"></i>Basic Information</h6>
                        <table class="table table-sm table-borderless">
                            <tr>
                                <td class="w-140"><strong>Name:</strong></td>
                                <td>${author.author}</td>
                            </tr>
                            <tr>
                                <td><strong>Ecosystem:</strong></td>
                                <td><span class="badge bg-info">${author.ecosystem}</span></td>
                            </tr>
                            <tr>
                                <td><strong>Package Count:</strong></td>
                                <td>
                                    <span class="badge bg-primary">${uniquePackageCount}</span>
                                    ${occurrenceCount > uniquePackageCount ? `<small class="text-muted ms-2">(${occurrenceCount} occurrences)</small>` : ''}
                                </td>
                            </tr>
                            <tr>
                                <td><strong>Repository Usage:</strong></td>
                                <td>
                                    <span class="badge bg-secondary">${repositoryCount} repo${repositoryCount !== 1 ? 's' : ''}</span>
                                    ${repositoryCount >= 5 ? '<span class="badge bg-danger ms-2" title="High risk: Single point of failure">High Risk</span>' : ''}
                                    ${repositoryCount >= 3 && repositoryCount < 5 ? '<span class="badge bg-warning text-dark ms-2" title="Moderate risk">Moderate Risk</span>' : ''}
                                </td>
                            </tr>
                        </table>
                    </div>
                `;
                
            // Verified Profile Links
            const verifiedLinks = getVerifiedProfileLinks(author);
            
            if (verifiedLinks.length > 0) {
                html += `
                    <div class="mb-3">
                        <h6><i class="fas fa-link me-2"></i>Profile Links</h6>
                        <div class="d-flex flex-wrap gap-2">
                `;
                
                verifiedLinks.forEach(link => {
                    html += `
                        <a href="${link.url}" target="_blank" class="btn btn-sm ${link.class}">
                            <i class="${link.icon} me-1"></i>
                            ${link.label}
                        </a>
                    `;
                });
                
                // Ecosyste.ms profile for aggregate stats
                const ecosystemMap = {
                    'npm': 'npmjs.org',
                    'pypi': 'pypi.org',
                    'cargo': 'crates.io',
                    'gem': 'rubygems.org',
                    'nuget': 'nuget.org',
                    'packagist': 'packagist.org'
                };
                const registryName = ecosystemMap[author.ecosystem.toLowerCase()];
                if (registryName) {
                    // For ecosyste.ms, use the correct identifier for each ecosystem
                    let maintainerIdentifier = author.author;
                    
                    // For PyPI, prefer username from metadata (e.g., "gastlygem" not "Weiwei Wang")
                    if (author.ecosystem === 'pypi' && author.metadata?.pypi_username) {
                        maintainerIdentifier = author.metadata.pypi_username;
                    }
                    // For npm, ecosyste.ms uses the username (from maintainers[].name), not display name
                    // Use npm_username from metadata if available, otherwise fall back to author.author
                    else if (author.ecosystem === 'npm') {
                        // npm maintainer identifier is the username (e.g., "tmpvar"), not display name
                        // ecosyste.ms expects the username format
                        maintainerIdentifier = author.metadata?.npm_username || author.author;
                    }
                    
                    html += `
                        <a href="https://packages.ecosyste.ms/registries/${registryName}/maintainers/${encodeURIComponent(maintainerIdentifier)}" target="_blank" class="btn btn-sm btn-outline-info">
                            <i class="fas fa-chart-bar me-1"></i>
                            Package Statistics
                        </a>
                    `;
                }
                
                html += '</div></div>';
            }
                
                // Show metadata if available
                if (author.metadata) {
                    html += `
                        <div class="mb-3">
                            <h6><i class="fas fa-info-circle me-2"></i>Additional Details</h6>
                            <table class="table table-sm table-borderless">
                    `;
                    
                    if (author.metadata.email) {
                        html += `
                            <tr>
                                <td class="w-140"><strong>Email:</strong></td>
                                <td><a href="mailto:${author.metadata.email}">${author.metadata.email}</a></td>
                            </tr>
                        `;
                    }
                    
                    if (author.metadata.github) {
                        html += `
                            <tr>
                                <td><strong>GitHub:</strong></td>
                                <td><a href="https://github.com/${author.metadata.github}" target="_blank">
                                    <i class="fab fa-github me-1"></i>${author.metadata.github}
                                </a></td>
                            </tr>
                        `;
                    }
                    
                    if (author.metadata.url) {
                        html += `
                            <tr>
                                <td><strong>Website:</strong></td>
                                <td><a href="${author.metadata.url}" target="_blank">${author.metadata.url}</a></td>
                            </tr>
                        `;
                    }
                    
                    html += '</table></div>';
                }
                
                // Sponsorship & Support Info - Only show if author has funding metadata (author-level, not package-level)
                if (author.funding) {
                    html += `
                        <div class="mb-3">
                            <h6><i class="fas fa-heart me-2"></i>Author Sponsorship Available</h6>
                            <div class="alert alert-success mb-2">
                                <small>
                                    <i class="fas fa-check-circle me-1"></i>
                                    <strong>${author.author}</strong> is accepting personal sponsorships (author-level support).
                                    They maintain ${uniquePackageCount} package${uniquePackageCount !== 1 ? 's' : ''} used by your project.
                                </small>
                            </div>
                            <div class="d-flex flex-wrap gap-2">
                    `;
                    
                    // Show platform-specific links if available (using secure URL validation)
                    if (author.funding.github || (author.funding.url && authorService.isUrlFromHostname(author.funding.url, 'github.com', '/sponsors'))) {
                        html += `
                            <a href="https://github.com/sponsors/${encodeURIComponent(author.author)}" target="_blank" class="btn btn-sm btn-outline-danger">
                                <i class="fas fa-heart me-1"></i>GitHub Sponsors
                            </a>
                        `;
                    }
                    
                    if (author.funding.opencollective || (author.funding.url && authorService.isUrlFromHostname(author.funding.url, 'opencollective.com'))) {
                        // Securely extract Open Collective username from URL
                        let ocUsername = author.author;
                        if (author.funding.url && authorService.isUrlFromHostname(author.funding.url, 'opencollective.com')) {
                            try {
                                const url = new URL(author.funding.url.startsWith('http') ? author.funding.url : 'https://' + author.funding.url);
                                const pathParts = url.pathname.split('/').filter(p => p);
                                if (pathParts.length > 0) {
                                    ocUsername = pathParts[0];
                                }
                            } catch (e) {
                                // If URL parsing fails, use author name as fallback
                                ocUsername = author.author;
                            }
                        }
                        html += `
                            <a href="https://opencollective.com/${encodeURIComponent(ocUsername)}" target="_blank" class="btn btn-sm btn-outline-primary">
                                <i class="fas fa-hand-holding-usd me-1"></i>Open Collective
                            </a>
                        `;
                    }
                    
                    if (author.funding.patreon || (author.funding.url && authorService.isUrlFromHostname(author.funding.url, 'patreon.com'))) {
                        html += `
                            <a href="${author.funding.url || `https://patreon.com/${encodeURIComponent(author.author)}`}" target="_blank" class="btn btn-sm btn-outline-danger">
                                <i class="fab fa-patreon me-1"></i>Patreon
                            </a>
                        `;
                    }
                    
                    // Show generic funding URL if no specific platform detected
                    if (author.funding.url && !author.funding.github && !author.funding.opencollective && !author.funding.patreon) {
                        html += `
                            <a href="${author.funding.url}" target="_blank" class="btn btn-sm btn-outline-info">
                                <i class="fas fa-donate me-1"></i>Support
                            </a>
                        `;
                    }
                    
                    html += `
                            </div>
                        </div>
                    `;
                }
                
                // Get current organization context for links
                const currentOrg = document.getElementById('analysisSelector')?.value || 'combined';
                const orgParamForLink = (currentOrg === 'combined' || currentOrg === 'Combined (All Scans)') ? null : currentOrg;
                
                // Helper function to create deps.html URL with package search filter
                const createPackageLink = (packageName) => {
                    const params = new URLSearchParams();
                    if (orgParamForLink) {
                        params.set('org', orgParamForLink);
                    }
                    params.set('search', packageName);
                    return `deps.html?${params.toString()}`;
                };
                
                // Helper function to create deps.html URL with repo filter
                const createRepoLink = (repo) => {
                    const params = new URLSearchParams();
                    if (orgParamForLink) {
                        params.set('org', orgParamForLink);
                    }
                    params.set('repo', repo);
                    return `deps.html?${params.toString()}`;
                };
                
                // Show ALL packages with repository usage
                html += `
                    <div class="mb-3">
                        <h6><i class="fas fa-box me-2"></i>Packages & Repository Usage (${uniquePackageCount})</h6>
                        <div class="list-group max-h-400 overflow-y-auto">
                `;
                
                allPackages.forEach(pkg => {
                    const repos = packageRepositories[pkg] || [];
                    const repoCount = repos.length;
                    
                    html += `
                        <div class="list-group-item">
                            <div class="d-flex justify-content-between align-items-start">
                                <div class="flex-grow-1">
                                    <strong><a href="${createPackageLink(pkg)}" class="text-decoration-none" target="_blank">${escapeHtml(pkg)}</a></strong>
                                    ${repoCount > 0 ? `
                                        <br><small class="text-muted">
                                            <i class="fas fa-folder me-1"></i>
                                            Used in <strong>${repoCount}</strong> repositor${repoCount !== 1 ? 'ies' : 'y'}
                                        </small>
                                    ` : '<br><small class="text-muted">Repository usage data not available</small>'}
                                </div>
                                ${repoCount > 0 ? `<span class="badge bg-secondary ms-2">${repoCount}</span>` : ''}
                            </div>
                            ${repoCount > 0 && repoCount <= 10 ? `
                                <div class="mt-2">
                                    <small class="text-muted">
                                        <i class="fas fa-code-branch me-1"></i>
                                        ${repos.map(r => `<a href="${createRepoLink(r)}" class="text-decoration-none" target="_blank"><code>${escapeHtml(r)}</code></a>`).join(', ')}
                                    </small>
                                </div>
                            ` : repoCount > 10 ? `
                                <div class="mt-2">
                                    <small class="text-muted">
                                        <i class="fas fa-code-branch me-1"></i>
                                        ${repos.slice(0, 5).map(r => `<a href="${createRepoLink(r)}" class="text-decoration-none" target="_blank"><code>${escapeHtml(r)}</code></a>`).join(', ')}
                                        <strong>+ ${repoCount - 5} more</strong>
                                    </small>
                                </div>
                            ` : ''}
                        </div>
                    `;
                });
                
                html += `
                        </div>
                    </div>
                `;
                
                // Risk Assessment - Focus on repository usage (single point of failure risk)
                if (repositoryCount >= 5) {
                    html += `
                        <div class="alert alert-danger">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            <strong>High Single Point of Failure Risk:</strong> This contributor's packages are used across <strong>${repositoryCount} repositories</strong> (${uniquePackageCount} unique package${uniquePackageCount !== 1 ? 's' : ''}).
                            <br><br>
                            <strong>Risk:</strong> If this maintainer becomes unavailable, inactive, or compromised, ${repositoryCount} of your projects could be affected.
                            <br><br>
                            <strong>Recommendations:</strong>
                            <ul class="mb-0">
                                <li>Monitor this maintainer's activity and repository health</li>
                                <li>Consider identifying backup or alternative packages</li>
                                <li>Contribute to their projects to support sustainability</li>
                                <li>Document dependencies and mitigation plans</li>
                            </ul>
                        </div>
                    `;
                } else if (repositoryCount >= 3) {
                    html += `
                        <div class="alert alert-warning">
                            <i class="fas fa-info-circle me-2"></i>
                            <strong>Moderate Single Point of Failure Risk:</strong> This contributor's packages are used across <strong>${repositoryCount} repositories</strong> (${uniquePackageCount} unique package${uniquePackageCount !== 1 ? 's' : ''}).
                            <br><br>
                            Consider monitoring their activity and having contingency plans.
                        </div>
                    `;
                } else if (uniquePackageCount >= 5) {
                    html += `
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>
                            <strong>Package Diversity:</strong> This contributor maintains ${uniquePackageCount} unique packages in your project.
                        </div>
                    `;
                }
                
                document.getElementById('authorDetailsContent').innerHTML = html;
                modal.show();
            }

            function displayAuthors(authors, ecosystemFilter) {
                const container = document.getElementById('authorContent');
                
                console.log(`ðŸŽ¨ Authors Page - Displaying authors. Total: ${authors ? authors.length : 0}, Filter: ${ecosystemFilter}`);
                
                if (!authors || authors.length === 0) {
                    console.log('âš ï¸ Authors Page - No authors to display');
                    container.innerHTML = '<p class="text-muted text-center">No author data available. Run an analysis to generate author information.</p>';
                    return;
                }
                
                // Filter by ecosystem
                let filtered = authors;
                if (ecosystemFilter !== 'all') {
                    filtered = authors.filter(a => a.ecosystem === ecosystemFilter);
                    console.log(`ðŸŽ¨ Authors Page - After filtering by ${ecosystemFilter}: ${filtered.length} authors`);
                }
                
                // Filter by funding if checkbox is checked
                const fundingFilterCheckbox = document.getElementById('fundingFilter');
                if (fundingFilterCheckbox && fundingFilterCheckbox.checked) {
                    filtered = filtered.filter(a => a.funding && (a.funding.github || a.funding.opencollective || a.funding.patreon || a.funding.tidelift || a.funding.url));
                    console.log(`ðŸŽ¨ Authors Page - After filtering by funding: ${filtered.length} authors`);
                }
                
                if (filtered.length === 0) {
                    console.log('âš ï¸ Authors Page - No authors after filtering');
                    const fundingFilterCheckbox = document.getElementById('fundingFilter');
                    const fundingFilterActive = fundingFilterCheckbox && fundingFilterCheckbox.checked;
                    let message = 'No authors found';
                    if (ecosystemFilter !== 'all' && fundingFilterActive) {
                        message = `No authors found for ecosystem "${ecosystemFilter}" with funding. Try selecting "All Ecosystems" or removing the funding filter.`;
                    } else if (ecosystemFilter !== 'all') {
                        message = `No authors found for ecosystem "${ecosystemFilter}". Try selecting "All Ecosystems".`;
                    } else if (fundingFilterActive) {
                        message = 'No authors found with funding information.';
                    }
                    container.innerHTML = `<p class="text-muted text-center">${escapeHtml(message)}</p>`;
                    return;
                }
                
                // Separate authors:
                // 1. Multi-package authors (2+ packages) -> Always show in main table
                // 2. Single-package authors with multiple repos (1 package, 2+ repos) -> Show in main table (risk)
                // 3. Single-package authors with single repo (1 package, 1 repo) -> Hide behind section (low risk)
                const multiPackageAuthors = filtered.filter(a => {
                    const uniquePackages = [...new Set(a.packages || [])];
                    return uniquePackages.length > 1;
                });
                
                const singlePackageMultipleRepos = filtered.filter(a => {
                    const uniquePackages = [...new Set(a.packages || [])];
                    const repoCount = a.repositoryCount || 0;
                    return uniquePackages.length === 1 && repoCount > 1;
                });
                
                const singlePackageSingleRepo = filtered.filter(a => {
                    const uniquePackages = [...new Set(a.packages || [])];
                    const repoCount = a.repositoryCount || 0;
                    return uniquePackages.length === 1 && repoCount === 1;
                });
                
                // Combine multi-package and single-package-multiple-repos for main display
                const visibleAuthors = [...multiPackageAuthors, ...singlePackageMultipleRepos];
                
                // Sort visible authors by repository count (risk factor), then package count
                visibleAuthors.sort((a, b) => {
                    const aRepoCount = a.repositoryCount || 0;
                    const bRepoCount = b.repositoryCount || 0;
                    if (bRepoCount !== aRepoCount) {
                        return bRepoCount - aRepoCount;
                    }
                    const aPkgCount = [...new Set(a.packages || [])].length;
                    const bPkgCount = [...new Set(b.packages || [])].length;
                    if (bPkgCount !== aPkgCount) {
                        return bPkgCount - aPkgCount;
                    }
                    return (b.count || 0) - (a.count || 0);
                });
                
                // Sort single-package-single-repo authors by occurrence count (descending)
                singlePackageSingleRepo.sort((a, b) => {
                    return (b.count || 0) - (a.count || 0);
                });
                
                // Store for event handlers
                currentAuthors = visibleAuthors;
                window.currentSinglePackageAuthors = singlePackageSingleRepo; // Store globally for toggle (low-risk authors)
                
                console.log(`ðŸŽ¨ Authors Page - Visible: ${visibleAuthors.length} (${multiPackageAuthors.length} multi-package + ${singlePackageMultipleRepos.length} single-package-multi-repo), Hidden: ${singlePackageSingleRepo.length} (single-package-single-repo)`);
                
                let html = `
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        Showing <strong>${visibleAuthors.length}</strong> authors from <strong>${new Set(visibleAuthors.map(a => a.ecosystem)).size}</strong> ecosystems
                        ${multiPackageAuthors.length > 0 ? `(${multiPackageAuthors.length} with multiple packages, ${singlePackageMultipleRepos.length} with single package across multiple repos)` : ''}
                    </div>
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th>Author</th>
                                    <th>Ecosystem</th>
                                    <th>Packages</th>
                                    <th>Repository Usage</th>
                                    <th class="text-center">Sponsorship</th>
                                    <th>Package List</th>
                                </tr>
                            </thead>
                            <tbody>
                `;
                
                visibleAuthors.forEach((author, index) => {
                    const uniquePackages = [...new Set(author.packages)];
                    const uniquePackageCount = uniquePackages.length;
                    const repositoryCount = author.repositoryCount || 0;
                    const samplePackages = uniquePackages.slice(0, 3).join(', ');
                    
                    // Build sponsorship cell
                    let sponsorshipCell = '<td class="text-center">â€”</td>';
                    if (author.funding) {
                        const platforms = [];
                        if (author.funding.github) platforms.push('<a href="' + (author.funding.url || `https://github.com/sponsors/${encodeURIComponent(author.author)}`) + '" target="_blank" title="GitHub Sponsors"><i class="fab fa-github text-dark"></i></a>');
                        if (author.funding.opencollective) {
                            // Securely extract Open Collective username from URL
                            let ocUsername = author.author;
                            if (author.funding.url && authorService.isUrlFromHostname(author.funding.url, 'opencollective.com')) {
                                try {
                                    const url = new URL(author.funding.url.startsWith('http') ? author.funding.url : 'https://' + author.funding.url);
                                    const pathParts = url.pathname.split('/').filter(p => p);
                                    if (pathParts.length > 0) {
                                        ocUsername = pathParts[0];
                                    }
                                } catch (e) {
                                    // If URL parsing fails, use author name as fallback
                                    ocUsername = author.author;
                                }
                            }
                            platforms.push('<a href="https://opencollective.com/' + encodeURIComponent(ocUsername) + '" target="_blank" title="Open Collective"><i class="fas fa-hand-holding-usd text-primary"></i></a>');
                        }
                        if (author.funding.patreon) platforms.push('<a href="' + (author.funding.url || `https://patreon.com/${encodeURIComponent(author.author)}`) + '" target="_blank" title="Patreon"><i class="fab fa-patreon text-danger"></i></a>');
                        if (author.funding.tidelift) platforms.push('<a href="' + author.funding.url + '" target="_blank" title="Tidelift"><i class="fas fa-gift text-warning"></i></a>');
                        
                        if (platforms.length > 0) {
                            sponsorshipCell = '<td class="text-center"><span class="d-flex justify-content-center gap-2">' + platforms.join(' ') + '</span></td>';
                        } else if (author.funding.url) {
                            sponsorshipCell = '<td class="text-center"><a href="' + author.funding.url + '" target="_blank" title="Funding available"><i class="fas fa-donate text-success"></i></a></td>';
                        }
                    }
                    
                    // Risk indicator: High repository usage = single point of failure
                    let riskBadge = '';
                    if (repositoryCount >= 5) {
                        riskBadge = ' <span class="badge bg-danger ms-1" title="High risk: Single point of failure across multiple projects">High Risk</span>';
                    } else if (repositoryCount >= 3) {
                        riskBadge = ' <span class="badge bg-warning text-dark ms-1" title="Moderate risk: Used across multiple projects">Moderate Risk</span>';
                    }
                    
                    html += `
                        <tr>
                            <td>${index + 1}</td>
                            <td>
                                <a href="#" class="text-decoration-none author-details-link" data-author-index="${index}">
                                    <strong><i class="fas fa-user me-1"></i>${author.author}</strong>
                                </a>
                            </td>
                            <td><span class="badge bg-info">${author.ecosystem}</span></td>
                            <td><span class="badge bg-primary">${uniquePackageCount}</span></td>
                            <td>
                                <span class="badge bg-secondary">${repositoryCount} repo${repositoryCount !== 1 ? 's' : ''}</span>
                                ${riskBadge}
                            </td>
                            ${sponsorshipCell}
                            <td>
                                <a href="#" class="text-decoration-none package-list-link" data-author-index="${index}">
                                    <small>${samplePackages}${uniquePackages.length > 3 ? ` <strong>+ ${uniquePackages.length - 3} more</strong>` : ''}</small>
                                    <i class="fas fa-external-link-alt ms-1 small"></i>
                                </a>
                            </td>
                        </tr>
                    `;
                });
                
                html += `
                            </tbody>
                        </table>
                    </div>
                `;
                
                // Add single-package-single-repo authors summary with toggle (low-risk, hidden by default)
                if (singlePackageSingleRepo.length > 0) {
                    html += `
                        <div class="alert alert-secondary mt-3 cursor-pointer" id="singlePackageAuthorsToggle">
                            <i class="fas fa-info-circle me-2"></i>
                            <strong>${singlePackageSingleRepo.length}</strong> additional author${singlePackageSingleRepo.length !== 1 ? 's' : ''} 
                            with one package used in one repository ${ecosystemFilter !== 'all' ? 'in this ecosystem ' : ''}
                            <span class="text-decoration-underline ms-2">
                                <i class="fas fa-chevron-down" id="singlePackageAuthorsToggleIcon"></i>
                                <span id="singlePackageAuthorsToggleText">Click to show</span>
                            </span>
                        </div>
                        <div id="singlePackageAuthorsList" class="mt-3 d-none">
                            <div class="alert alert-info">
                                <i class="fas fa-info-circle me-2"></i>
                                These authors maintain only one package used in a single repository (lower risk - isolated impact).
                            </div>
                            <div class="table-responsive">
                                <table class="table table-hover table-sm">
                                    <thead>
                                        <tr>
                                            <th>#</th>
                                            <th>Author</th>
                                            <th>Ecosystem</th>
                                            <th>Package</th>
                                            <th>Repository</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                    `;
                    
                    singlePackageSingleRepo.forEach((author, index) => {
                        const packageName = author.packages[0] || 'N/A';
                        const repositories = author.repositories || [];
                        const repoName = repositories.length > 0 ? repositories[0] : 'N/A';
                        
                        html += `
                            <tr>
                                <td>${index + 1}</td>
                                <td>
                                    <a href="#" class="text-decoration-none single-author-details-link" data-author-index="${index}">
                                        <i class="fas fa-user me-1"></i>${author.author}
                                    </a>
                                </td>
                                <td><span class="badge bg-info">${author.ecosystem}</span></td>
                                <td><code>${packageName}</code></td>
                                <td><code>${repoName}</code></td>
                            </tr>
                        `;
                    });
                    
                    html += `
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    `;
                }
                
                container.innerHTML = html;
                
                // Attach event listeners
                attachEventListeners();
            }
            
            function attachEventListeners() {
                // Author details links
                document.querySelectorAll('.author-details-link').forEach(link => {
                    link.addEventListener('click', function(e) {
                        e.preventDefault();
                        const index = parseInt(this.getAttribute('data-author-index'));
                        const author = currentAuthors[index];
                        if (author) {
                            showAuthorDetailsModal(author);
                        }
                    });
                });
                
                // Package list links
                document.querySelectorAll('.package-list-link').forEach(link => {
                    link.addEventListener('click', function(e) {
                        e.preventDefault();
                        const index = parseInt(this.getAttribute('data-author-index'));
                        const author = currentAuthors[index];
                        if (author) {
                            showPackageModal(author);
                        }
                    });
                });
                
                // Single package authors toggle
                const toggleElement = document.getElementById('singlePackageAuthorsToggle');
                if (toggleElement) {
                    toggleElement.addEventListener('click', function(e) {
                        e.preventDefault();
                        const listElement = document.getElementById('singlePackageAuthorsList');
                        const iconElement = document.getElementById('singlePackageAuthorsToggleIcon');
                        const textElement = document.getElementById('singlePackageAuthorsToggleText');
                        
                        if (!listElement || !iconElement || !textElement) return;
                        
                        // Check if hidden using Bootstrap's d-none class
                        const isHidden = listElement.classList.contains('d-none');
                        
                        if (isHidden) {
                            // Show the list
                            listElement.classList.remove('d-none');
                            iconElement.classList.remove('fa-chevron-down');
                            iconElement.classList.add('fa-chevron-up');
                            textElement.textContent = 'Click to hide';
                        } else {
                            // Hide the list
                            listElement.classList.add('d-none');
                            iconElement.classList.remove('fa-chevron-up');
                            iconElement.classList.add('fa-chevron-down');
                            textElement.textContent = 'Click to show';
                        }
                    });
                }
                
                // Single author details links
                document.querySelectorAll('.single-author-details-link').forEach(link => {
                    link.addEventListener('click', function(e) {
                        e.preventDefault();
                        const index = parseInt(this.getAttribute('data-author-index'));
                        const author = window.currentSinglePackageAuthors?.[index];
                        if (author) {
                            showAuthorDetailsModal(author);
                        }
                    });
                });
            }
        });
    </script>

    <!-- Footer -->
    <footer class="bg-light mt-5 py-4">
        <div class="container">
            <div class="row">
                <!-- First Column: SBOM Play Tool -->
                <div class="col-md-4">
                    <h6 class="text-primary">SBOM Play</h6>
                    <p class="text-muted small mb-3">
                        A client-side tool for analyzing Software Bill of Materials from GitHub organizations and users.
                        All processing happens in your browser for maximum privacy and security.
                    </p>
                    <p class="text-muted small mb-0">
                        <strong>Privacy-First:</strong> All processing happens in your browser<br>
                        <strong>No Server Required:</strong> Works entirely client-side<br>
                        <strong>Persistent Storage:</strong> Results saved in browser storage<br>
                        <strong>Rate Limit Aware:</strong> Handles GitHub API limits intelligently
                    </p>
                </div>
                
                <!-- Second Column: Links -->
                <div class="col-md-4">
                    <h6 class="text-primary">Resources</h6>
                    <div class="d-flex flex-column gap-2">
                        <a href="https://cyfinoid.com/" target="_blank" class="btn btn-outline-primary btn-sm">
                            <i class="fas fa-globe me-1"></i>Website
                        </a>
                        <a href="https://cyfinoid.com/blog/" target="_blank" class="btn btn-outline-primary btn-sm">
                            <i class="fas fa-blog me-1"></i>Blog
                        </a>
                        <a href="https://cyfinoid.com/trainings/#upcoming-trainings" target="_blank" class="btn btn-outline-primary btn-sm">
                            <i class="fas fa-graduation-cap me-1"></i>Upcoming Trainings
                        </a>
                        <a href="https://cyfinoid.com/opensource-by-cyfinoid/" target="_blank" class="btn btn-outline-primary btn-sm">
                            <i class="fab fa-github me-1"></i>Open Source by Cyfinoid
                        </a>
                    </div>
                </div>
                
                <!-- Third Column: Company Information -->
                <div class="col-md-4">
                    <h6 class="text-primary">About Cyfinoid Research</h6>
                    <p class="text-muted small mb-3">
                        Leading cybersecurity research company specializing in software supply chain security, 
                        Android security, and cloud security. Our expertise spans across comprehensive software 
                        supply chain protection.
                    </p>
                </div>
            </div>
            <hr class="my-3">
            <div class="text-center">
                <small class="text-muted">
                    Â© 2025 Cyfinoid Research. All rights reserved. | 
                    <a href="https://github.com/cyfinoid/sbomplay" target="_blank" class="text-muted">
                        <i class="fab fa-github me-1"></i>View on GitHub
                    </a>
                </small>
            </div>
        </div>
    </footer>
</body>
</html>

