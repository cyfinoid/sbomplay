<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SBOM Play - Statistics Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="css/style.css?v=10" rel="stylesheet">
    <link href="css/themes.css?v=10" rel="stylesheet">
    <script src="js/theme-manager.js?v=10"></script>
    <script defer data-domain="cyfinoid.github.io" src="https://plausible.io/js/script.outbound-links.js"></script>
<script>window.plausible = window.plausible || function() { (window.plausible.q = window.plausible.q || []).push(arguments) }</script>

</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="index.html">
                <i class="fas fa-cubes me-2"></i>SBOM Play
            </a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="index.html">Analysis</a>
                <a class="nav-link active" href="stats.html">Stats</a>
                <a class="nav-link" href="license-compliance.html">License</a>
                <a class="nav-link" href="vuln.html">Vulnerabilities</a>
                <a class="nav-link" href="quality.html">Quality</a>
                <a class="nav-link" href="deps.html">Dependencies</a>
                <a class="nav-link" href="authors.html">Authors</a>
                <a class="nav-link" href="settings.html">
                    <i class="fas fa-cog"></i>
                </a>
                <button class="btn btn-outline-secondary btn-sm ms-2 theme-toggle" onclick="themeManager.toggleTheme()" title="Toggle theme">
                    <i class="fas fa-sun"></i>
                </button>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container mt-4">
        <!-- Header -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h1>üìä Statistics Dashboard</h1>
                        <p class="text-muted">High-level overview of all your SBOM analyses</p>
                    </div>
                    <div>
                        <a href="index.html" class="btn btn-outline-primary">
                            <i class="fas fa-arrow-left me-2"></i>Back to Analysis
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <!-- Dashboard Overview -->
        <div id="dashboardOverview" class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-chart-line me-2"></i>Overview
                </h5>
            </div>
            <div class="card-body">
                <div id="overviewContent">
                    <div class="text-center text-muted">
                        <i class="fas fa-spinner fa-spin fa-2x mb-3"></i>
                        <p>Loading dashboard data...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- SBOM Quality Dashboard -->
        <div id="qualityDashboard" class="card mb-4" style="display: none;">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-certificate me-2"></i>SBOM Quality Assessment
                </h5>
            </div>
            <div class="card-body">
                <div id="qualityContent">
                    <!-- Quality data will be populated by JavaScript -->
                </div>
            </div>
        </div>

        <!-- Quick Stats Cards -->
        <div id="statsCards" class="row mb-4">
            <!-- Stats will be populated by JavaScript -->
        </div>

        <!-- No Data Section -->
        <div id="noDataSection" class="card mb-4" style="display: none;">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-info-circle me-2"></i>No Data Available
                </h5>
            </div>
            <div class="card-body text-center">
                <i class="fas fa-database fa-3x text-muted mb-3"></i>
                <h5>No Stored Analyses Found</h5>
                <p class="text-muted">
                    You haven't analyzed any organizations yet, or all data has been cleared.
                </p>
                <a href="index.html" class="btn btn-primary">
                    <i class="fas fa-play me-2"></i>Start Your First Analysis
                </a>
            </div>
        </div>

    </div>

    <!-- Footer -->
    <footer class="bg-light mt-5 py-4">
        <div class="container">
            <div class="row">
                <!-- First Column: SBOM Play Tool -->
                <div class="col-md-4">
                    <h6 class="text-primary">SBOM Play</h6>
                    <p class="text-muted small mb-3">
                        A client-side tool for analyzing Software Bill of Materials from GitHub organizations and users.
                        All processing happens in your browser for maximum privacy and security.
                    </p>
                    <p class="text-muted small mb-0">
                        <strong>Privacy-First:</strong> All processing happens in your browser<br>
                        <strong>No Server Required:</strong> Works entirely client-side<br>
                        <strong>Persistent Storage:</strong> Results saved in browser storage<br>
                        <strong>Rate Limit Aware:</strong> Handles GitHub API limits intelligently
                    </p>
                </div>
                
                <!-- Second Column: Links -->
                <div class="col-md-4">
                    <h6 class="text-primary">Resources</h6>
                    <div class="d-flex flex-column gap-2">
                        <a href="https://cyfinoid.com/" target="_blank" class="btn btn-outline-primary btn-sm">
                            <i class="fas fa-globe me-1"></i>Website
                        </a>
                        <a href="https://cyfinoid.com/blog/" target="_blank" class="btn btn-outline-primary btn-sm">
                            <i class="fas fa-blog me-1"></i>Blog
                        </a>
                        <a href="https://cyfinoid.com/trainings/#upcoming-trainings" target="_blank" class="btn btn-outline-primary btn-sm">
                            <i class="fas fa-graduation-cap me-1"></i>Upcoming Trainings
                        </a>
                        <a href="https://cyfinoid.com/opensource-by-cyfinoid/" target="_blank" class="btn btn-outline-primary btn-sm">
                            <i class="fab fa-github me-1"></i>Open Source by Cyfinoid
                        </a>
                    </div>
                </div>
                
                <!-- Third Column: Company Information -->
                <div class="col-md-4">
                    <h6 class="text-primary">About Cyfinoid Research</h6>
                    <p class="text-muted small mb-3">
                        Leading cybersecurity research company specializing in software supply chain security, 
                        Android security, and cloud security. Our expertise spans across comprehensive software 
                        supply chain protection.
                    </p>
                </div>
            </div>
            <hr class="my-3">
            <div class="text-center">
                <small class="text-muted">
                    ¬© 2025 Cyfinoid Research. All rights reserved. | 
                    <a href="https://github.com/cyfinoid/sbomplay" target="_blank" class="text-muted">
                        <i class="fab fa-github me-1"></i>View on GitHub
                    </a>
                </small>
            </div>
        </div>
    </footer>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="js/indexeddb-manager.js?v=10"></script>
    <script src="js/registry-utils.js?v=10"></script>
    <script src="js/version-utils.js?v=10"></script>
    <script src="js/ecosystem-utils.js?v=10"></script>
    <script src="js/cache-manager.js?v=10"></script>
    <script src="js/github-client.js?v=10"></script>
    <script src="js/sbom-quality-processor.js?v=10"></script>
    <script src="js/sbom-processor.js?v=10"></script>
    <script src="js/license-processor.js?v=10"></script>
    <script src="js/osv-service.js?v=10"></script>
    <script src="js/storage-manager.js?v=10"></script>
    <script src="js/view-manager.js?v=10"></script>
    <script src="js/app.js?v=10"></script>
    <script type="module">
        // Dashboard app for the combined view
        class DashboardApp {
            constructor() {
                this.storageManager = new StorageManager();
                this.viewManager = new ViewManager();
                this.init();
            }

            async init() {
                await this.storageManager.init();
                await this.loadDashboardData();
            }

            /**
             * Load and display dashboard data
             */
            async loadDashboardData() {
                const storageInfo = await this.storageManager.getStorageInfo();
                console.log('üîç Stats Page - Storage Info:', storageInfo);
                
                if (storageInfo.totalEntries === 0) {
                    console.log('üîç Stats Page - No entries found, showing no data section');
                    document.getElementById('dashboardOverview').style.display = 'none';
                    document.getElementById('statsCards').style.display = 'none';
                    document.getElementById('noDataSection').style.display = 'block';
                    return;
                }

                // Show dashboard sections
                document.getElementById('dashboardOverview').style.display = 'block';
                document.getElementById('statsCards').style.display = 'block';
                document.getElementById('noDataSection').style.display = 'none';

                // Load combined data
                const combinedData = await this.storageManager.getCombinedData();
                console.log('üîç Stats Page - Combined Data:', combinedData);
                
                if (combinedData) {
                    console.log('üîç Stats Page - Displaying dashboard with data');
                    await this.displayDashboardOverview(combinedData);
                    this.displayQualityDashboard(combinedData);
                    this.displayStatsCards(combinedData);
                } else {
                    console.log('üîç Stats Page - No combined data available, showing no data message');
                    this.showNoDataMessage();
                }
            }

            /**
             * Display dashboard overview
             */
            async displayDashboardOverview(data) {
                const content = document.getElementById('overviewContent');
                
                console.log('üîç Stats Page - Display Dashboard Data:', data);
                console.log('üîç Stats Page - Data structure:', {
                    repositories: data.data.repositories,
                    dependencies: data.data.dependencies,
                    vulnerabilities: data.data.vulnerabilities,
                    licenses: data.data.licenses,
                    allDependencies: data.data.allDependencies,
                    allRepositories: data.data.allRepositories,
                    vulnerabilityAnalysis: data.data.vulnerabilityAnalysis,
                    licenseAnalysis: data.data.licenseAnalysis
                });
                
                // Calculate high-level stats
                const totalRepos = data.data.allRepositories?.length || 0;
                const totalDeps = data.data.allDependencies?.length || 0;
                
                // Extract vulnerabilities from vulnerabilityAnalysis
                let totalVulns = 0;
                if (data.data.vulnerabilityAnalysis && data.data.vulnerabilityAnalysis.vulnerableDependencies) {
                    totalVulns = data.data.vulnerabilityAnalysis.vulnerableDependencies.reduce((total, dep) => {
                        return total + (dep.vulnerabilities?.length || 0);
                    }, 0);
                }
                
                // Extract licenses from licenseAnalysis
                let totalLicenses = 0;
                if (data.data.licenseAnalysis && data.data.licenseAnalysis.summary) {
                    totalLicenses = data.data.licenseAnalysis.summary.totalDependencies || 0;
                }

                // Count packages and authors seeking sponsorship/donations
                const fundingStats = await this.getFundingStats(data);
                console.log('üîç Stats Page - Funding stats:', fundingStats);

                console.log('üîç Stats Page - Calculated totals:', {
                    totalRepos,
                    totalDeps,
                    totalVulns: totalVulns,
                    totalLicenses,
                    packagesWithFunding: fundingStats.packagesWithFunding,
                    authorsWithFunding: fundingStats.authorsWithFunding
                });

                const html = `
                    <div class="row">
                        <div class="col-md-6">
                            <h6>üìä Combined Analysis Summary</h6>
                            <p class="text-muted small mb-3">
                                Aggregated data from all analyzed organizations
                            </p>
                        </div>
                        <div class="col-md-6 text-end">
                            <a href="license-compliance.html" class="btn btn-outline-primary btn-sm me-2">
                                <i class="fas fa-file-contract me-1"></i>License Details
                            </a>
                            <a href="vuln.html" class="btn btn-outline-warning btn-sm me-2">
                                <i class="fas fa-shield-alt me-1"></i>Vulnerability Details
                            </a>
                            <a href="deps.html" class="btn btn-outline-info btn-sm">
                                <i class="fas fa-cubes me-1"></i>Dependency Details
                            </a>
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-md-3">
                            <div class="text-center">
                                <h4 class="text-primary">${totalRepos}</h4>
                                <small class="text-muted">Repositories</small>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center">
                                <h4 class="text-success">${totalDeps}</h4>
                                <small class="text-muted">Dependencies</small>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center">
                                <h4 class="text-warning">${totalVulns}</h4>
                                <small class="text-muted">Vulnerabilities</small>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center">
                                <h4 class="text-info">${totalLicenses}</h4>
                                <small class="text-muted">Licenses</small>
                            </div>
                        </div>
                    </div>
                    ${fundingStats.packagesWithFunding > 0 || fundingStats.authorsWithFunding > 0 ? `
                    <div class="row mt-3 pt-3 border-top">
                        <div class="col-12 mb-2">
                            <h6><i class="fas fa-heart me-2"></i>Funding & Sponsorship Opportunities</h6>
                        </div>
                        <div class="col-md-4">
                            <div class="text-center">
                                ${fundingStats.directPackagesWithFunding > 0 ? `
                                <a href="deps-table.html?funding=true&direct=true" class="text-decoration-none text-success">
                                    <h4 class="text-success">
                                        <i class="fas fa-layer-group me-2"></i>${fundingStats.directPackagesWithFunding}
                                    </h4>
                                    <small class="text-muted">Direct Dependencies</small>
                                    <p class="text-muted small mb-0 mt-1">
                                        <i class="fas fa-info-circle me-1"></i>
                                        Packages directly used by your repositories
                                    </p>
                                </a>
                                ` : `
                                <h4 class="text-success">
                                    <i class="fas fa-layer-group me-2"></i>0
                                </h4>
                                <small class="text-muted">Direct Dependencies</small>
                                <p class="text-muted small mb-0 mt-1">No direct dependencies with funding</p>
                                `}
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="text-center">
                                ${fundingStats.packagesWithFunding > 0 ? `
                                <a href="deps-table.html?funding=true" class="text-decoration-none text-info">
                                    <h4 class="text-info">
                                        <i class="fas fa-sitemap me-2"></i>${fundingStats.packagesWithFunding}
                                    </h4>
                                    <small class="text-muted">All Dependencies</small>
                                    <p class="text-muted small mb-0 mt-1">
                                        <i class="fas fa-info-circle me-1"></i>
                                        Includes transitive dependencies in supply chain
                                    </p>
                                </a>
                                ` : `
                                <h4 class="text-info">
                                    <i class="fas fa-sitemap me-2"></i>0
                                </h4>
                                <small class="text-muted">All Dependencies</small>
                                <p class="text-muted small mb-0 mt-1">No dependencies with funding found</p>
                                `}
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="text-center">
                                ${fundingStats.authorsWithFunding > 0 ? `
                                <a href="authors.html?funding=true" class="text-decoration-none text-primary">
                                    <h4 class="text-primary">
                                        <i class="fas fa-users me-2"></i>${fundingStats.authorsWithFunding}
                                    </h4>
                                    <small class="text-muted">Package Authors</small>
                                    <p class="text-muted small mb-0 mt-1">
                                        <i class="fas fa-info-circle me-1"></i>
                                        Maintainers accepting personal sponsorships
                                    </p>
                                </a>
                                ` : `
                                <h4 class="text-primary">
                                    <i class="fas fa-users me-2"></i>0
                                </h4>
                                <small class="text-muted">Package Authors</small>
                                <p class="text-muted small mb-0 mt-1">No authors with funding found</p>
                                `}
                            </div>
                        </div>
                    </div>
                    ` : ''}
                `;
                
                content.innerHTML = html;
            }

            /**
             * Display SBOM Quality Dashboard
             */
            displayQualityDashboard(data) {
                const qualityDashboard = document.getElementById('qualityDashboard');
                const qualityContent = document.getElementById('qualityContent');
                
                if (!data.data.qualityAnalysis) {
                    qualityDashboard.style.display = 'none';
                    return;
                }
                
                qualityDashboard.style.display = 'block';
                const qa = data.data.qualityAnalysis;
                
                // Get color class for score
                const getScoreColor = (score) => {
                    if (score >= 80) return 'success';
                    if (score >= 60) return 'warning';
                    return 'danger';
                };
                
                // Build HTML
                let html = `
                    <div class="row mb-4">
                        <div class="col-md-3 text-center">
                            <h2 class="text-${getScoreColor(qa.averageOverallScore)}">${qa.averageOverallScore}/100</h2>
                            <p class="text-muted">Average Quality Score</p>
                        </div>
                        <div class="col-md-9">
                            <div class="row">
                                <div class="col-md-3">
                                    <p class="mb-1 small"><strong>Identification</strong></p>
                                    <div class="progress" style="height: 20px;">
                                        <div class="progress-bar bg-${getScoreColor(qa.averageIdentification)}" 
                                             role="progressbar" 
                                             style="width: ${qa.averageIdentification}%"
                                             aria-valuenow="${qa.averageIdentification}" 
                                             aria-valuemin="0" 
                                             aria-valuemax="100">${qa.averageIdentification}</div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <p class="mb-1 small"><strong>Structure</strong></p>
                                    <div class="progress" style="height: 20px;">
                                        <div class="progress-bar bg-${getScoreColor(qa.averageStructure)}" 
                                             role="progressbar" 
                                             style="width: ${qa.averageStructure}%"
                                             aria-valuenow="${qa.averageStructure}" 
                                             aria-valuemin="0" 
                                             aria-valuemax="100">${qa.averageStructure}</div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <p class="mb-1 small"><strong>Metadata</strong></p>
                                    <div class="progress" style="height: 20px;">
                                        <div class="progress-bar bg-${getScoreColor(qa.averageMetadata)}" 
                                             role="progressbar" 
                                             style="width: ${qa.averageMetadata}%"
                                             aria-valuenow="${qa.averageMetadata}" 
                                             aria-valuemin="0" 
                                             aria-valuemax="100">${qa.averageMetadata}</div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <p class="mb-1 small"><strong>Completeness</strong></p>
                                    <div class="progress" style="height: 20px;">
                                        <div class="progress-bar bg-${getScoreColor(qa.averageCompleteness)}" 
                                             role="progressbar" 
                                             style="width: ${qa.averageCompleteness}%"
                                             aria-valuenow="${qa.averageCompleteness}" 
                                             aria-valuemin="0" 
                                             aria-valuemax="100">${qa.averageCompleteness}</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-12">
                            <h6>Grade Distribution</h6>
                            <div class="d-flex gap-3">
                                <span class="badge bg-success">A: ${qa.gradeDistribution.A || 0}</span>
                                <span class="badge bg-info">B: ${qa.gradeDistribution.B || 0}</span>
                                <span class="badge bg-primary">C: ${qa.gradeDistribution.C || 0}</span>
                                <span class="badge bg-warning">D: ${qa.gradeDistribution.D || 0}</span>
                                <span class="badge bg-danger">F: ${qa.gradeDistribution.F || 0}</span>
                                ${qa.gradeDistribution['N/A'] > 0 ? `<span class="badge bg-secondary">N/A: ${qa.gradeDistribution['N/A']}</span>` : ''}
                            </div>
                        </div>
                    </div>
                `;
                
                // Add repositories needing attention
                if (qa.repositoriesNeedingAttention && qa.repositoriesNeedingAttention.length > 0) {
                    html += `
                        <div class="alert alert-warning">
                            <h6><i class="fas fa-exclamation-triangle me-2"></i>Repositories Needing Attention (${qa.repositoriesNeedingAttention.length})</h6>
                            <p class="small mb-2">These repositories have SBOM quality scores below 70%:</p>
                            <div class="table-responsive">
                                <table class="table table-sm table-hover mb-0">
                                    <thead>
                                        <tr>
                                            <th>Repository</th>
                                            <th>Score</th>
                                            <th>Grade</th>
                                            <th>Top Issues</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                    `;
                    
                    qa.repositoriesNeedingAttention.slice(0, 10).forEach(repo => {
                        const issueCategories = repo.topIssues.map(issue => issue.category).join(', ');
                        html += `
                            <tr>
                                <td><code>${repo.repository}</code></td>
                                <td><span class="badge bg-${getScoreColor(repo.score)}">${repo.score}</span></td>
                                <td><span class="badge bg-secondary">${repo.grade}</span></td>
                                <td><small>${issueCategories}</small></td>
                            </tr>
                        `;
                    });
                    
                    html += `
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    `;
                }
                
                qualityContent.innerHTML = html;
            }

            /**
             * Display stats cards
             */
            displayStatsCards(data) {
                const statsContainer = document.getElementById('statsCards');
                
                // Calculate additional stats
                const topLanguages = this.getTopLanguages(data);
                const topVulnerabilities = this.getTopVulnerabilities(data);
                const licenseCompliance = this.getLicenseCompliance(data);

                const html = `
                    <div class="row gy-3">
                        <div class="col-md-4">
                            <div class="card h-100">
                                <div class="card-header">
                                    <h6 class="mb-0"><i class="fas fa-code me-2"></i>Top Languages</h6>
                                </div>
                                <div class="card-body">
                                    ${this.renderTopLanguages(topLanguages)}
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card h-100">
                                <div class="card-header">
                                    <h6 class="mb-0"><i class="fas fa-exclamation-triangle me-2"></i>Critical Issues</h6>
                                </div>
                                <div class="card-body">
                                    ${this.renderTopVulnerabilities(topVulnerabilities)}
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card h-100">
                                <div class="card-header">
                                    <h6 class="mb-0"><i class="fas fa-file-contract me-2"></i>License Status</h6>
                                </div>
                                <div class="card-body">
                                    ${this.renderLicenseCompliance(licenseCompliance)}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                statsContainer.innerHTML = html;
            }

            /**
             * Get top languages from data
             */
            getTopLanguages(data) {
                console.log('üîç Stats Page - Getting top languages from data:', data.data.languageStats);
                
                if (!data.data.languageStats) {
                    console.log('üîç Stats Page - No language stats available');
                    return [];
                }
                
                const languages = Object.entries(data.data.languageStats)
                    .sort(([,a], [,b]) => b - a)
                    .slice(0, 5)
                    .map(([lang, count]) => ({ language: lang, count }));
                
                console.log('üîç Stats Page - Top languages:', languages);
                return languages;
            }

            /**
             * Get top vulnerabilities from data
             */
            getTopVulnerabilities(data) {
                console.log('üîç Stats Page - Getting top vulnerabilities from data:', data.data.vulnerabilityAnalysis);
                
                if (!data.data.vulnerabilityAnalysis || !data.data.vulnerabilityAnalysis.vulnerableDependencies) {
                    console.log('üîç Stats Page - No vulnerability analysis available');
                    return [];
                }
                
                const vulnCounts = {};
                data.data.vulnerabilityAnalysis.vulnerableDependencies.forEach(dep => {
                    if (dep.vulnerabilities) {
                        dep.vulnerabilities.forEach(vuln => {
                            const severity = vuln.severity || 'unknown';
                            vulnCounts[severity] = (vulnCounts[severity] || 0) + 1;
                        });
                    }
                });
                
                const vulnerabilities = Object.entries(vulnCounts)
                    .sort(([,a], [,b]) => b - a)
                    .map(([severity, count]) => ({ severity, count }));
                
                console.log('üîç Stats Page - Top vulnerabilities:', vulnerabilities);
                return vulnerabilities;
            }

            /**
             * Get license compliance stats
             */
            getLicenseCompliance(data) {
                console.log('üîç Stats Page - Getting license compliance from data:', data.data.licenseAnalysis);
                
                if (!data.data.licenseAnalysis || !data.data.licenseAnalysis.summary) {
                    console.log('üîç Stats Page - No license analysis available');
                    return { total: 0, compliant: 0, nonCompliant: 0 };
                }
                
                const summary = data.data.licenseAnalysis.summary;
                const total = summary.totalDependencies || 0;
                const compliant = summary.licensedDependencies || 0;
                
                const result = {
                    total,
                    compliant,
                    nonCompliant: total - compliant
                };
                
                console.log('üîç Stats Page - License compliance:', result);
                return result;
            }

            /**
             * Render top languages
             */
            renderTopLanguages(languages) {
                if (languages.length === 0) {
                    return '<p class="text-muted small">No language data available</p>';
                }
                
                return languages.map(lang => 
                    `<div class="d-flex justify-content-between align-items-center mb-2">
                        <span class="small">${lang.language}</span>
                        <span class="badge bg-primary">${lang.count}</span>
                    </div>`
                ).join('');
            }

            /**
             * Render top vulnerabilities
             */
            renderTopVulnerabilities(vulnerabilities) {
                if (vulnerabilities.length === 0) {
                    return '<p class="text-muted small">No vulnerability data available</p>';
                }
                
                const severityColors = {
                    'critical': 'danger',
                    'high': 'warning',
                    'medium': 'info',
                    'low': 'secondary',
                    'unknown': 'light',
                    'CRITICAL': 'danger',
                    'HIGH': 'warning',
                    'MEDIUM': 'info',
                    'LOW': 'secondary',
                    'UNKNOWN': 'light'
                };
                
                return vulnerabilities.map(vuln => {
                    const severity = vuln.severity || 'unknown';
                    const color = severityColors[severity] || 'light';
                    return `<div class="d-flex justify-content-between align-items-center mb-2">
                        <span class="small text-capitalize">${severity.toLowerCase()}</span>
                        <span class="badge bg-${color}">${vuln.count}</span>
                    </div>`;
                }).join('');
            }

            /**
             * Render license compliance
             */
            renderLicenseCompliance(compliance) {
                if (compliance.total === 0) {
                    return '<p class="text-muted small">No license data available</p>';
                }
                
                const compliantPercent = compliance.total > 0 ? 
                    ((compliance.compliant / compliance.total) * 100).toFixed(1) : 0;
                
                return `
                    <div class="text-center mb-3">
                        <h4 class="text-${compliantPercent >= 80 ? 'success' : compliantPercent >= 60 ? 'warning' : 'danger'}">${compliantPercent}%</h4>
                        <small class="text-muted">Compliant</small>
                    </div>
                    <div class="row text-center">
                        <div class="col-6">
                            <small class="text-success">${compliance.compliant} Compliant</small>
                        </div>
                        <div class="col-6">
                            <small class="text-danger">${compliance.nonCompliant} Issues</small>
                        </div>
                    </div>
                `;
            }

            /**
             * Get funding statistics (packages and authors seeking sponsorship)
             */
            async getFundingStats(data) {
                let packagesWithFunding = 0;
                let directPackagesWithFunding = 0;
                let authorsWithFunding = 0;

                if (!window.cacheManager || !window.indexedDBManager) {
                    console.warn('‚ö†Ô∏è Stats: Cache manager not available for funding stats');
                    return { packagesWithFunding: 0, directPackagesWithFunding: 0, authorsWithFunding: 0 };
                }

                try {
                    // Count packages with funding
                    // Get all unique packages from allDependencies
                    if (data.data.allDependencies && Array.isArray(data.data.allDependencies)) {
                        const uniquePackages = new Set();
                        data.data.allDependencies.forEach(dep => {
                            // Try multiple methods to extract package key
                            let packageKey = null;
                            
                            // Method 1: Check if dep has packageKey directly
                            if (dep.packageKey) {
                                packageKey = dep.packageKey;
                            }
                            // Method 2: Extract from PURL
                            else if (dep.purl) {
                                const purlMatch = dep.purl.match(/pkg:([^\/]+)\/([^@\/]+)/);
                                if (purlMatch) {
                                    const ecosystem = purlMatch[1];
                                    const name = purlMatch[2];
                                    packageKey = `${ecosystem}:${name}`;
                                }
                            }
                            // Method 3: Use name and ecosystem if available
                            else if (dep.name && dep.ecosystem) {
                                packageKey = `${dep.ecosystem}:${dep.name}`;
                            }
                            // Method 4: Try to infer ecosystem from category
                            else if (dep.name && dep.category?.ecosystem) {
                                packageKey = `${dep.category.ecosystem}:${dep.name}`;
                            }

                            if (packageKey) {
                                uniquePackages.add(packageKey);
                            }
                        });

                        console.log(`üìä Stats: Checking ${uniquePackages.size} unique packages for funding...`);

                        // Also track which packages are direct vs transitive
                        const directPackages = new Set();
                        data.data.allDependencies.forEach(dep => {
                            if (dep.directIn && Array.isArray(dep.directIn) && dep.directIn.length > 0) {
                                // This dependency is direct in at least one repository
                                let packageKey = null;
                                if (dep.packageKey) {
                                    packageKey = dep.packageKey;
                                } else if (dep.purl) {
                                    const purlMatch = dep.purl.match(/pkg:([^\/]+)\/([^@\/]+)/);
                                    if (purlMatch) {
                                        packageKey = `${purlMatch[1]}:${purlMatch[2]}`;
                                    }
                                } else if (dep.name && dep.category?.ecosystem) {
                                    packageKey = `${dep.category.ecosystem}:${dep.name}`;
                                }
                                if (packageKey) {
                                    directPackages.add(packageKey);
                                }
                            }
                        });

                        // Check each package for funding (use Promise.all for parallel lookups)
                        const packageArray = Array.from(uniquePackages);
                        const packageChecks = packageArray.map(async (packageKey) => {
                            const packageData = await window.cacheManager.getPackage(packageKey);
                            const hasFunding = packageData && packageData.funding ? 1 : 0;
                            const isDirect = directPackages.has(packageKey) ? 1 : 0;
                            return { hasFunding, isDirect };
                        });

                        // Wait for all checks to complete
                        const results = await Promise.all(packageChecks);
                        packagesWithFunding = results.reduce((sum, pkg) => sum + pkg.hasFunding, 0);
                        directPackagesWithFunding = results.reduce((sum, pkg) => sum + (pkg.hasFunding && pkg.isDirect ? 1 : 0), 0);
                        console.log(`üìä Stats: Found ${packagesWithFunding} packages with funding (${directPackagesWithFunding} direct)`);
                    }

                    // Count authors with funding
                    // Get all author references from authorAnalysis
                    if (data.data.authorAnalysis && data.data.authorAnalysis.authors) {
                        const authorRefs = data.data.authorAnalysis.authors;
                        const uniqueAuthorKeys = new Set();

                        // Collect unique author keys
                        authorRefs.forEach(ref => {
                            if (ref.authorKey) {
                                uniqueAuthorKeys.add(ref.authorKey);
                            }
                        });

                        // Check each author for funding (use Promise.all for parallel lookups)
                        const authorChecks = Array.from(uniqueAuthorKeys).map(async (authorKey) => {
                            const authorEntity = await window.cacheManager.getAuthorEntity(authorKey);
                            return authorEntity && authorEntity.funding ? 1 : 0;
                        });

                        // Wait for all checks to complete
                        const authorResults = await Promise.all(authorChecks);
                        authorsWithFunding = authorResults.reduce((sum, count) => sum + count, 0);
                        console.log(`üìä Stats: Found ${authorsWithFunding} authors with funding`);
                    }

                    console.log('üìä Stats: Funding stats calculated', {
                        packagesWithFunding,
                        directPackagesWithFunding,
                        authorsWithFunding
                    });

                } catch (error) {
                    console.error('‚ùå Stats: Failed to calculate funding stats:', error);
                }

                return { packagesWithFunding, directPackagesWithFunding, authorsWithFunding };
            }

            /**
             * Show no data message
             */
            showNoDataMessage() {
                document.getElementById('dashboardOverview').style.display = 'none';
                document.getElementById('statsCards').style.display = 'none';
                document.getElementById('noDataSection').style.display = 'block';
            }

            /**
             * Show alert
             */
            showAlert(message, type) {
                const alertDiv = document.createElement('div');
                alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
                alertDiv.innerHTML = `
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                `;
                
                const container = document.querySelector('.container');
                container.insertBefore(alertDiv, container.firstChild);
                
                // Auto-dismiss after 5 seconds
                setTimeout(() => {
                    if (alertDiv.parentNode) {
                        alertDiv.remove();
                    }
                }, 5000);
            }
        }

        // Initialize the dashboard app
        let dashboardApp;
        document.addEventListener('DOMContentLoaded', () => {
            dashboardApp = new DashboardApp();
        });
    </script>
</body>
</html> 