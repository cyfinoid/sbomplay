<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SBOM Play - Data Explorer</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="css/style.css" rel="stylesheet">
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="index.html">
                <i class="fas fa-cubes me-2"></i>SBOM Play
            </a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="index.html">Analysis</a>
                <a class="nav-link active" href="view.html">Explore</a>
                <a class="nav-link" href="license-compliance.html">License</a>
                <a class="nav-link" href="vuln.html">Vulnerabilities</a>
                <a class="nav-link" href="deps.html">Dependencies</a>
                <a class="nav-link" href="settings.html">
                    <i class="fas fa-cog"></i>
                </a>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container mt-4">
        <!-- Header -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h1>üîç SBOM Data Explorer</h1>
                        <p class="text-muted">Explore and navigate through your stored SBOM analyses</p>
                    </div>
                    <div>
                        <a href="index.html" class="btn btn-outline-primary">
                            <i class="fas fa-arrow-left me-2"></i>Back to Analysis
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <!-- Storage Management -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-hdd me-2"></i>Storage Management
                </h5>
            </div>
            <div class="card-body">
                <div id="storageStatus" class="mb-3">
                    <!-- Storage status will be populated by JavaScript -->
                </div>
                <div class="row">
                    <div class="col-md-6">
                        <button class="btn btn-outline-primary btn-sm" onclick="explorerApp.showStorageStatus()">
                            <i class="fas fa-info-circle me-2"></i>Check Storage Status
                        </button>
                        <button class="btn btn-outline-success btn-sm" onclick="explorerApp.exportAllData()">
                            <i class="fas fa-download me-2"></i>Export All Data
                        </button>
                        <button class="btn btn-outline-info btn-sm" onclick="explorerApp.testStorageQuota()">
                            <i class="fas fa-vial me-2"></i>Test Storage
                        </button>
                        <button class="btn btn-outline-secondary btn-sm" onclick="explorerApp.migrateOldData()">
                            <i class="fas fa-sync me-2"></i>Migrate Data
                        </button>
                    </div>
                    <div class="col-md-6 text-end">
                        <button class="btn btn-outline-warning btn-sm" onclick="explorerApp.clearOldData()">
                            <i class="fas fa-broom me-2"></i>Clear Old Data
                        </button>
                        <button class="btn btn-outline-danger btn-sm" onclick="explorerApp.clearAllData()">
                            <i class="fas fa-trash me-2"></i>Clear All Data
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Stored Analyses Section -->
        <div id="organizationsSection" class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-database me-2"></i>Stored Analyses
                </h5>
            </div>
            <div class="card-body">
                <div id="organizationsContent">
                    <div class="text-center text-muted">
                        <i class="fas fa-spinner fa-spin fa-2x mb-3"></i>
                        <p>Loading stored analyses...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Detailed View Container -->
        <div id="view-container" style="display: none;" class="mb-4">
            <!-- Detailed views will be loaded here -->
            <div class="mb-3">
                <button class="btn btn-outline-secondary" onclick="explorerApp.goBackToResults()">
                    <i class="fas fa-arrow-left me-2"></i>Back to Results
                </button>
            </div>
        </div>

        <!-- No Data Section -->
        <div id="noDataSection" class="card mb-4" style="display: none;">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-info-circle me-2"></i>No Data Available
                </h5>
            </div>
            <div class="card-body text-center">
                <i class="fas fa-database fa-3x text-muted mb-3"></i>
                <h5>No Stored Analyses Found</h5>
                <p class="text-muted">
                    You haven't analyzed any organizations yet, or all data has been cleared.
                </p>
                <a href="index.html" class="btn btn-primary">
                    <i class="fas fa-play me-2"></i>Start Your First Analysis
                </a>
            </div>
        </div>


    <!-- Footer -->
    <footer class="bg-light mt-5 py-4">
        <div class="container">
            <div class="row">
                <!-- First Column: SBOM Play Tool -->
                <div class="col-md-4">
                    <h6 class="text-primary">SBOM Play</h6>
                    <p class="text-muted small mb-3">
                        A client-side tool for analyzing Software Bill of Materials from GitHub organizations and users.
                        All processing happens in your browser for maximum privacy and security.
                    </p>
                    <p class="text-muted small mb-0">
                        <strong>Privacy-First:</strong> All processing happens in your browser<br>
                        <strong>No Server Required:</strong> Works entirely client-side<br>
                        <strong>Persistent Storage:</strong> Results saved in browser storage<br>
                        <strong>Rate Limit Aware:</strong> Handles GitHub API limits intelligently
                    </p>
                </div>
                
                <!-- Second Column: Links -->
                <div class="col-md-4">
                    <h6 class="text-primary">Resources</h6>
                    <div class="d-flex flex-column gap-2">
                        <a href="https://cyfinoid.com/" target="_blank" class="btn btn-outline-primary btn-sm">
                            <i class="fas fa-globe me-1"></i>Website
                        </a>
                        <a href="https://cyfinoid.com/blog/" target="_blank" class="btn btn-outline-primary btn-sm">
                            <i class="fas fa-blog me-1"></i>Blog
                        </a>
                        <a href="https://cyfinoid.com/trainings/#upcoming-trainings" target="_blank" class="btn btn-outline-primary btn-sm">
                            <i class="fas fa-graduation-cap me-1"></i>Upcoming Trainings
                        </a>
                        <a href="https://cyfinoid.com/opensource-by-cyfinoid/" target="_blank" class="btn btn-outline-primary btn-sm">
                            <i class="fab fa-github me-1"></i>Open Source by Cyfinoid
                        </a>
                    </div>
                </div>
                
                <!-- Third Column: Company Information -->
                <div class="col-md-4">
                    <h6 class="text-primary">About Cyfinoid Research</h6>
                    <p class="text-muted small mb-3">
                        Leading cybersecurity research company specializing in software supply chain security, 
                        Android security, and cloud security. Our expertise spans across comprehensive software 
                        supply chain protection.
                    </p>
                </div>
            </div>
            <hr class="my-3">
            <div class="text-center">
                <small class="text-muted">
                    ¬© 2025 Cyfinoid Research. All rights reserved. | 
                    <a href="https://github.com/cyfinoid/sbomplay" target="_blank" class="text-muted">
                        <i class="fab fa-github me-1"></i>View on GitHub
                    </a>
                </small>
            </div>
        </div>
    </footer>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="js/github-client.js"></script>
    <script src="js/sbom-processor.js"></script>
    <script src="js/license-processor.js"></script>
    <script src="js/osv-service.js"></script>
    <script src="js/storage-manager.js"></script>
    <script src="js/view-manager.js"></script>
    <script src="js/app.js"></script>
    <script>
        // Simplified app for the explorer view
        class SBOMExplorerApp {
            constructor() {
                this.storageManager = new StorageManager();
                this.viewManager = new ViewManager();
                this.init();
            }

            init() {
                this.showStorageStatus();
                this.displayOrganizationsOverview();
            }

            /**
             * Display organizations overview
             */
            displayOrganizationsOverview() {
                const storageInfo = this.storageManager.getStorageInfo();
                
                if (storageInfo.organizationsCount === 0) {
                    document.getElementById('organizationsSection').style.display = 'none';
                    document.getElementById('noDataSection').style.display = 'block';
                    return;
                }

                const content = document.getElementById('organizationsContent');
                const organizations = storageInfo.organizations;
                
                let html = `
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <h6>Stored Organizations (${organizations.length})</h6>
                        </div>
                        <div class="col-md-6 text-end">
                            <button class="btn btn-outline-primary btn-sm" onclick="explorerApp.exportAllData()">
                                <i class="fas fa-download me-2"></i>Export All
                            </button>
                            <button class="btn btn-outline-danger btn-sm" onclick="explorerApp.clearAllData()">
                                <i class="fas fa-trash me-2"></i>Clear All
                            </button>
                        </div>
                    </div>
                `;

                // Add combined view if there are multiple organizations
                if (organizations.length > 1) {
                    const combinedStats = organizations.reduce((acc, org) => {
                        acc.repositories += org.repositories;
                        acc.dependencies += org.dependencies;
                        return acc;
                    }, { repositories: 0, dependencies: 0 });

                    html += `
                        <div class="alert alert-info mb-3">
                            <div class="row align-items-center">
                                <div class="col-md-8">
                                    <h6 class="mb-1"><i class="fas fa-layer-group me-2"></i>Combined Analysis</h6>
                                    <p class="mb-0 small">View aggregated data from all ${organizations.length} organizations</p>
                                </div>
                                <div class="col-md-4 text-end">
                                    <button class="btn btn-primary btn-sm" onclick="explorerApp.showCombinedView()">
                                        <i class="fas fa-chart-line me-2"></i>View Combined
                                    </button>
                                    <button class="btn btn-outline-info btn-sm ms-1" onclick="explorerApp.debugCombinedData()">
                                        <i class="fas fa-bug me-1"></i>Debug
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                }

                if (organizations.length > 0) {
                    html += `
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>Organization</th>
                                        <th>Repositories</th>
                                        <th>Dependencies</th>
                                        <th>Last Updated</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                    `;

                    organizations.forEach(org => {
                        const date = new Date(org.timestamp).toLocaleDateString();
                        const time = new Date(org.timestamp).toLocaleTimeString();
                        
                        html += `
                            <tr>
                                <td><strong>${org.name}</strong></td>
                                <td><span class="badge bg-primary">${org.repositories}</span></td>
                                <td><span class="badge bg-success">${org.dependencies}</span></td>
                                <td><small>${date} ${time}</small></td>
                                <td>
                                    <button class="btn btn-outline-primary btn-sm" onclick="explorerApp.showDetailedViewForOrg('${org.name}')">
                                        <i class="fas fa-eye me-1"></i>View
                                    </button>
                                    <button class="btn btn-outline-info btn-sm" onclick="explorerApp.debugOrganizationData('${org.name}')">
                                        <i class="fas fa-bug me-1"></i>Debug
                                    </button>
                                    <button class="btn btn-outline-danger btn-sm" onclick="explorerApp.removeOrganizationData('${org.name}')">
                                        <i class="fas fa-trash me-1"></i>Remove
                                    </button>
                                </td>
                            </tr>
                        `;
                    });

                    html += `
                                </tbody>
                            </table>
                        </div>
                    `;
                }

                content.innerHTML = html;
                document.getElementById('organizationsSection').style.display = 'block';
            }

            /**
             * Load organization data
             */
            loadOrganizationData(orgName) {
                const data = this.storageManager.loadAnalysisDataForOrganization(orgName);
                if (data) {
                    // Show detailed view directly
                    this.showDetailedViewForOrg(orgName);
                } else {
                    this.showAlert(`No data found for ${orgName}`, 'warning');
                }
            }

            /**
             * Debug organization data
             */
            debugOrganizationData(orgName) {
                const data = this.storageManager.loadAnalysisDataForOrganization(orgName);
                if (data) {
                    // Show view container
                    document.getElementById('view-container').style.display = 'block';
                    
                    // Show raw data debug view
                    this.viewManager.showRawData(data);
                } else {
                    this.showAlert(`No data found for ${orgName}`, 'warning');
                }
            }

            /**
             * Show detailed view for a specific organization
             */
            showDetailedViewForOrg(orgName) {
                const data = this.storageManager.loadAnalysisDataForOrganization(orgName);
                if (data) {
                    console.log('Loading detailed view for:', orgName, data);
                    
                    // Show view container
                    document.getElementById('view-container').style.display = 'block';
                    
                    // Show organization overview using view manager
                    this.viewManager.showOrganizationOverview(data);
                } else {
                    this.showAlert(`No detailed data found for ${orgName}`, 'warning');
                }
            }

            /**
             * Show combined view from all organizations
             */
            showCombinedView() {
                const combinedData = this.storageManager.getCombinedData();
                if (combinedData) {
                    console.log('Loading combined view:', combinedData);
                    
                    // Debug: Show raw combined data
                    console.log('üîç Combined Data Debug:');
                    console.log('Category Stats:', combinedData.data.categoryStats);
                    console.log('Language Stats:', combinedData.data.languageStats);
                    
                    // Show view container
                    document.getElementById('view-container').style.display = 'block';
                    
                    // Show combined organization overview using view manager
                    this.viewManager.showOrganizationOverview(combinedData);
                } else {
                    this.showAlert('No data available for combined view', 'warning');
                }
            }

            /**
             * Debug combined data structure
             */
            debugCombinedData() {
                const combinedData = this.storageManager.getCombinedData();
                if (combinedData) {
                    console.log('üîç Combined Data Structure:');
                    console.log('Full combined data:', combinedData);
                    console.log('Category Stats:', combinedData.data.categoryStats);
                    console.log('Language Stats:', combinedData.data.languageStats);
                    
                    // Show raw data in view container
                    document.getElementById('view-container').style.display = 'block';
                    this.viewManager.showRawData(combinedData);
                } else {
                    this.showAlert('No combined data available for debugging', 'warning');
                }
            }

            /**
             * Remove organization data
             */
            removeOrganizationData(orgName) {
                if (confirm(`Are you sure you want to remove all data for ${orgName}?`)) {
                    const success = this.storageManager.removeOrganizationData(orgName);
                    if (success) {
                        this.showAlert(`Data for ${orgName} has been removed`, 'success');
                        this.displayOrganizationsOverview();
                        this.showStorageStatus(); // Update storage status
                        
                        // If this was the currently displayed data, clear the view
                        document.getElementById('view-container').style.display = 'none';
                    } else {
                        this.showAlert(`Failed to remove data for ${orgName}`, 'danger');
                    }
                }
            }

            /**
             * Export all data
             */
            exportAllData() {
                const success = this.storageManager.exportAllData();
                if (success) {
                    this.showAlert('All data exported successfully', 'success');
                } else {
                    this.showAlert('Failed to export all data', 'danger');
                }
            }

            /**
             * Clear all data
             */
            clearAllData() {
                if (confirm('Are you sure you want to clear all stored data? This action cannot be undone.')) {
                    const success = this.storageManager.clearAllData();
                    if (success) {
                        this.showAlert('All data cleared successfully', 'success');
                        document.getElementById('view-container').style.display = 'none';
                        document.getElementById('organizationsSection').style.display = 'none';
                        document.getElementById('noDataSection').style.display = 'block';
                        this.showStorageStatus(); // Update storage status
                    } else {
                        this.showAlert('Failed to clear data', 'danger');
                    }
                }
            }

            /**
             * Show storage status in UI
             */
            showStorageStatus() {
                const storageInfo = this.storageManager.getStorageInfo();
                const storageStatusDiv = document.getElementById('storageStatus');
                
                if (storageInfo) {
                    const usagePercent = (storageInfo.totalSize / storageInfo.maxStorageSize) * 100;
                    const usageClass = usagePercent > 90 ? 'danger' : usagePercent > 70 ? 'warning' : 'success';
                    
                    storageStatusDiv.innerHTML = `
                        <div class="alert alert-${usageClass}">
                            <h6><i class="fas fa-hdd me-2"></i>Storage Status</h6>
                            <div class="row">
                                <div class="col-md-6">
                                    <strong>Usage:</strong> ${(storageInfo.totalSize / 1024 / 1024).toFixed(2)}MB / ${(storageInfo.maxStorageSize / 1024 / 1024).toFixed(2)}MB (${usagePercent.toFixed(1)}%)
                                </div>
                                <div class="col-md-6">
                                    <strong>Available:</strong> ${(storageInfo.availableSpace / 1024 / 1024).toFixed(2)}MB
                                </div>
                            </div>
                            <div class="row mt-2">
                                <div class="col-md-6">
                                    <strong>Organizations:</strong> ${storageInfo.organizationsCount}
                                </div>
                                <div class="col-md-6">
                                    <strong>History Entries:</strong> ${storageInfo.historyCount}
                                </div>
                            </div>
                            ${usagePercent > 80 ? '<div class="mt-2"><strong>‚ö†Ô∏è Warning:</strong> Storage usage is high. Consider exporting data.</div>' : ''}
                        </div>
                    `;
                } else {
                    storageStatusDiv.innerHTML = `
                        <div class="alert alert-warning">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            Unable to retrieve storage status
                        </div>
                    `;
                }
            }

            /**
             * Clear old data (keep only recent)
             */
            clearOldData() {
                if (confirm('This will remove old analysis data while keeping the most recent. Continue?')) {
                    try {
                        const storageInfo = this.storageManager.getStorageInfo();
                        const organizations = storageInfo.organizations;
                        
                        if (organizations.length <= 3) {
                            this.showAlert('Not enough data to clear. Keep at least 3 recent analyses.', 'info');
                            return;
                        }
                        
                        // Keep only the 3 most recent organizations
                        organizations.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                        const toRemove = organizations.slice(3);
                        
                        let removedCount = 0;
                        for (const org of toRemove) {
                            if (this.storageManager.removeOrganizationData(org.name)) {
                                removedCount++;
                            }
                        }
                        
                        this.showAlert(`Cleared ${removedCount} old analyses. Kept 3 most recent.`, 'success');
                        this.displayOrganizationsOverview(); // Refresh display
                        this.showStorageStatus(); // Update storage status
                    } catch (error) {
                        console.error('Clear old data failed:', error);
                        this.showAlert('Failed to clear old data', 'danger');
                    }
                }
            }

            /**
             * Test storage quota management
             */
            testStorageQuota() {
                try {
                    const testResults = this.storageManager.testStorageQuota();
                    if (testResults) {
                        console.log('üß™ Storage quota test results:', testResults);
                        this.showAlert(`Storage test completed. Check console for details. Compression ratio: ${testResults.compressionRatio.toFixed(1)}%`, 'info');
                    } else {
                        this.showAlert('Storage test failed. Check console for details.', 'warning');
                    }
                } catch (error) {
                    console.error('Storage test failed:', error);
                    this.showAlert('Storage test failed', 'danger');
                }
            }

            /**
             * Migrate old data to new compressed format
             */
            migrateOldData() {
                try {
                    const migratedCount = this.storageManager.migrateOldData();
                    if (migratedCount > 0) {
                        this.showAlert(`Successfully migrated ${migratedCount} organizations to compressed format.`, 'success');
                        this.showStorageStatus(); // Update storage status
                        this.displayOrganizationsOverview(); // Refresh display
                    } else {
                        this.showAlert('No old data found to migrate. All data is already in compressed format.', 'info');
                    }
                } catch (error) {
                    console.error('Migration failed:', error);
                    this.showAlert('Failed to migrate old data', 'danger');
                }
            }

            /**
             * Show alert
             */
            showAlert(message, type) {
                const alertDiv = document.createElement('div');
                alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
                alertDiv.innerHTML = `
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                `;
                
                const container = document.querySelector('.container');
                container.insertBefore(alertDiv, container.firstChild);
                
                // Auto-dismiss after 5 seconds
                setTimeout(() => {
                    if (alertDiv.parentNode) {
                        alertDiv.remove();
                    }
                }, 5000);
            }
        }

        // Initialize the explorer app
        let explorerApp;
        document.addEventListener('DOMContentLoaded', () => {
            explorerApp = new SBOMExplorerApp();
        });
    </script>
</body>
</html> 